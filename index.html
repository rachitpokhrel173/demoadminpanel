<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMO - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .sidebar-mobile {
            transform: translateX(-100%);
        }

        @media (min-width: 1024px) {
            .sidebar-mobile {
                transform: translateX(0);
            }
        }

        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-screen w-64 bg-white shadow-lg z-50 transition-transform duration-300 overflow-y-auto sidebar-mobile">
        <div class="p-6 border-b">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold">DEMO</h1>
                        <p class="text-xs text-gray-500">Admin Panel</p>
                    </div>
                </div>
                <button onclick="closeSidebar()" class="lg:hidden text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <nav class="p-4">
            <a href="#" onclick="showPage(event, 'dashboard')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg mb-2 active">
                <i class="fas fa-dashboard"></i><span>Dashboard</span>
            </a>
            <a href="#" onclick="showPage(event, 'students')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-users"></i><span>Students</span>
            </a>
            <a href="#" onclick="showPage(event, 'visitors')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-user-friends"></i><span>Visitors</span>
            </a>
            <a href="#" onclick="showPage(event, 'tasks')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-tasks"></i><span>Tasks</span>
            </a>
            <a href="#" onclick="showPage(event, 'appointments')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-calendar"></i><span>Appointments</span>
            </a>
            <a href="#" onclick="showPage(event, 'classes')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-book"></i><span>Classes</span>
            </a>
            <a href="#" onclick="showPage(event, 'settings')"
                class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50 text-gray-700 mb-2">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="px-4 lg:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()" class="lg:hidden">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    <div>
                        <p class="text-sm text-gray-500" id="greetingText">Welcome back,</p>
                        <h2 class="font-semibold text-gray-800" id="welcomeMessage">Demo</h2>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div id="dbStatusBadge"
                        class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                        <i class="fas fa-database mr-1"></i>Connected
                    </div>
                    <button onclick="refreshAllData()" class="p-2 rounded-full hover:bg-gray-100">
                        <i class="fas fa-sync text-gray-600"></i>
                    </button>

                    <div class="flex items-center space-x-3">
                        <div class="hidden sm:block text-right">
                            <p class="text-xs text-gray-500">Logged in as</p>
                            <p id="userEmail" class="text-sm font-semibold text-gray-800">Loading...</p>
                        </div>
                        <div class="relative group">
                            <button
                                class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold shadow-lg hover:shadow-xl transition">
                                <i class="fas fa-user"></i>
                            </button>
                            <div
                                class="hidden group-hover:block absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border py-2 z-50">
                                <div class="px-4 py-2 border-b">
                                    <p class="text-xs text-gray-500">Signed in as</p>
                                    <p id="userEmailDropdown" class="text-sm font-semibold text-gray-800 truncate"></p>
                                </div>
                                <button onclick="logout()"
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 lg:p-6">

            <!-- DASHBOARD PAGE -->
            <div id="dashboard-page" class="page-section active">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Dashboard Overview</h1>
                    <button onclick="refreshAllData()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-sync mr-2"></i>Refresh All
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm">Total Students</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalApplicants">0</h3>
                                <p class="text-green-500 text-xs mt-2">Active</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-blue-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm">Total Visitors</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalVisitors">0</h3>
                                <p class="text-indigo-500 text-xs mt-2">All Time</p>
                            </div>
                            <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-friends text-indigo-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm">Pending Tasks</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="pendingTasks">0</h3>
                                <p class="text-amber-500 text-xs mt-2">To Complete</p>
                            </div>
                            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tasks text-amber-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm">Active Classes</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalClasses">0</h3>
                                <p class="text-green-500 text-xs mt-2">Running</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book text-green-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Recent Students</h3>
                        <div id="recentStudents" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">No students loaded</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Upcoming Appointments</h3>
                        <div id="upcomingAppointments" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">No appointments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STUDENTS PAGE -->
            <div id="students-page" class="page-section">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Student Management</h1>
                    <div class="flex gap-3">
                        <button onclick="loadApplicantsFromSheet()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-sync mr-2"></i>Load
                        </button>
                        <button onclick="exportToCSV()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <h3 class="text-lg font-semibold">All Students</h3>
                        <input type="text" id="searchInput" placeholder="Search..." class="px-4 py-2 border rounded-lg"
                            onkeyup="searchApplicants()">
                    </div>

                    <div id="loadingIndicator" class="hidden flex justify-center items-center py-8">
                        <div class="loading"></div>
                        <span class="ml-3 text-gray-600">Loading...</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Course
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="applicantsTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                        <i class="fas fa-cloud-download-alt text-4xl mb-2 text-blue-500"></i>
                                        <p class="font-semibold">Click Load to fetch students</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student Detail Modal -->
            <div id="studentDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-user-graduate text-blue-600 mr-2"></i>Student Details
                        </h2>
                        <button onclick="closeStudentDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="studentDetailContent" class="p-6">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>

            <script>
                // ==================== STUDENT/GOOGLE SHEETS FUNCTIONS ====================

                // IMPROVED HELPER FUNCTION - Handles ANY header format
                function getValue(obj, possibleKeys) {
                    // Try exact matches first
                    for (const key of possibleKeys) {
                        if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
                            return obj[key];
                        }
                    }

                    // Try flexible matching (case-insensitive, ignores spaces/underscores/dashes)
                    const normalizedObj = {};
                    Object.keys(obj).forEach(key => {
                        const normalized = key.toLowerCase().trim().replace(/[\s_-]/g, '');
                        normalizedObj[normalized] = obj[key];
                    });

                    for (const key of possibleKeys) {
                        const normalized = key.toLowerCase().trim().replace(/[\s_-]/g, '');
                        if (normalizedObj[normalized] !== undefined &&
                            normalizedObj[normalized] !== null &&
                            normalizedObj[normalized] !== '') {
                            return normalizedObj[normalized];
                        }
                    }

                    return 'N/A';
                }

                async function loadApplicantsFromSheet() {
                    const indicator = document.getElementById('loadingIndicator');
                    if (indicator) indicator.classList.remove('hidden');

                    try {
                        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                        console.log('üîç Fetching from:', url);

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.values && data.values.length > 0) {
                            const headers = data.values[0];

                            // üîç DEBUG: Show exact headers
                            console.log('üìä EXACT Sheet headers:', headers);
                            console.log('üìä Headers with index:');
                            headers.forEach((h, i) => console.log(`  ${i}: "${h}"`));

                            applicantsData = data.values.slice(1).map(row => {
                                let obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] || '';
                                });
                                return obj;
                            });

                            console.log('‚úÖ Loaded', applicantsData.length, 'students');
                            console.log('üìù First student data:', applicantsData[0]);
                            console.log('üìù First student keys:', Object.keys(applicantsData[0]));

                            displayApplicants();
                            updateAllStats();
                            showNotification('‚úÖ Students loaded successfully!', 'success');
                        } else {
                            console.warn('‚ö†Ô∏è No data in sheet');
                            showNotification('‚ö†Ô∏è No data found in sheet', 'warning');
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading students:', error);
                        showNotification('‚ùå Error loading students: ' + error.message, 'error');
                    } finally {
                        if (indicator) indicator.classList.add('hidden');
                    }
                }

                function displayApplicants() {
                    const tbody = document.getElementById('applicantsTableBody');
                    if (!tbody) return;

                    if (applicantsData.length === 0) {
                        tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-cloud-download-alt text-4xl mb-2 text-blue-500"></i>
                        <p class="font-semibold">Click Load to fetch students</p>
                    </td>
                </tr>
            `;
                        return;
                    }

                    tbody.innerHTML = applicantsData.map((applicant, index) => {
                        // EXPANDED field name variations - covers most common formats
                        const name = getValue(applicant, [
                            'Full Name', 'full name', 'Name', 'name', 'FullName', 'fullname',
                            'FULL NAME', 'Student Name', 'student name', 'STUDENT NAME',
                            'full_name', 'student_name', 'StudentName', 'Full_Name',
                            '‡§®‡§æ‡§Æ', '‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ'  // Added Nepali variants if needed
                        ]);

                        const email = getValue(applicant, [
                            'Email', 'email', 'E-mail', 'e-mail', 'EMAIL', 'Email Address',
                            'email address', 'EMAIL ADDRESS', 'email_address', 'EmailAddress',
                            'E_mail', 'E-Mail', '‡§à‡§Æ‡•á‡§≤'
                        ]);

                        const phone = getValue(applicant, [
                            'Personal Number', 'personal number', 'Phone', 'phone', 'PHONE',
                            'Contact', 'contact', 'Mobile', 'mobile', 'Phone Number', 'phone number',
                            'Contact Number', 'contact number', 'CONTACT NUMBER', 'MOBILE',
                            'personal_number', 'PersonalNumber', 'phone_number', 'PhoneNumber',
                            'contact_number', 'ContactNumber', 'mobile_number', 'MobileNumber',
                            'Mobile Number', 'MOBILE NUMBER', '‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤', '‡§´‡•ã‡§®'
                        ]);

                        const country = getValue(applicant, [
                            'Country', 'country', 'COUNTRY', 'Preferred Country', 'preferred country',
                            'Destination', 'destination', 'DESTINATION', 'PREFERRED COUNTRY',
                            'preferred_country', 'PreferredCountry', 'Preferred_Country',
                            '‡§¶‡•á‡§∂', '‡§ó‡§®‡•ç‡§§‡§µ‡•ç‡§Ø'
                        ]);

                        const course = getValue(applicant, [
                            'Course', 'course', 'COURSE', 'Program', 'program', 'Study Program',
                            'Preferred Course', 'preferred course', 'PROGRAM', 'PREFERRED COURSE',
                            'preferred_course', 'PreferredCourse', 'Preferred_Course',
                            '‡§ï‡•ã‡§∞‡•ç‡§∏', '‡§™‡§æ‡§†‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ'
                        ]);

                        return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium">${name}</td>
                    <td class="px-4 py-3 text-sm">${email}</td>
                    <td class="px-4 py-3 text-sm">${phone}</td>
                    <td class="px-4 py-3 text-sm">${country}</td>
                    <td class="px-4 py-3 text-sm">${course}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewApplicant(${index})" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
                    }).join('');

                    displayRecentStudents();
                }

                function viewApplicant(index) {
                    const applicant = applicantsData[index];
                    if (!applicant) return;

                    const content = document.getElementById('studentDetailContent');
                    if (!content) return;

                    const name = getValue(applicant, ['Full Name', 'Name', 'full_name', 'name', 'FullName', 'Student Name']);
                    const email = getValue(applicant, ['Email', 'email', 'email_address', 'EmailAddress']);
                    const phone = getValue(applicant, ['Personal Number', 'Phone', 'phone', 'personal_number', 'Mobile', 'Contact']);

                    // Get all fields dynamically
                    const fields = Object.entries(applicant);

                    content.innerHTML = `
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-lg text-blue-900">${name}</h3>
                    <p class="text-sm text-blue-600">${email}</p>
                    <p class="text-sm text-blue-600">${phone}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${fields.filter(([key]) =>
                        !['Full Name', 'Name', 'Email', 'Phone', 'Personal Number', 'Timestamp',
                            'full_name', 'name', 'email', 'phone', 'personal_number', 'timestamp'].includes(key)
                    ).map(([key, value]) => `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-1">${key}</p>
                            <p class="text-sm font-medium text-gray-800">${value || 'N/A'}</p>
                        </div>
                    `).join('')}
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeStudentDetailModal()" class="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm">
                        Close
                    </button>
                </div>
            </div>
        `;

                    document.getElementById('studentDetailModal').classList.remove('hidden');
                }

                function displayRecentStudents() {
                    const container = document.getElementById('recentStudents');
                    if (!container) return;

                    const recent = applicantsData.slice(0, 5);

                    if (recent.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No students loaded yet</p>';
                        return;
                    }

                    container.innerHTML = recent.map(student => {
                        const name = getValue(student, ['Full Name', 'Name', 'full_name', 'name', 'FullName']);
                        const email = getValue(student, ['Email', 'email', 'email_address']);

                        return `
                <div class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer" onclick="viewApplicant(${applicantsData.indexOf(student)})">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">${name}</p>
                        <p class="text-xs text-gray-500">${email}</p>
                    </div>
                </div>
            `;
                    }).join('');
                }

                function searchApplicants() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    const tbody = document.getElementById('applicantsTableBody');

                    if (!searchTerm) {
                        displayApplicants();
                        return;
                    }

                    const filtered = applicantsData.filter(applicant => {
                        return Object.values(applicant).some(value =>
                            String(value).toLowerCase().includes(searchTerm)
                        );
                    });

                    if (filtered.length === 0) {
                        tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-search text-4xl mb-2 text-gray-400"></i>
                        <p class="font-semibold">No students found matching "${searchTerm}"</p>
                    </td>
                </tr>
            `;
                        return;
                    }

                    tbody.innerHTML = filtered.map((applicant) => {
                        const name = getValue(applicant, ['Full Name', 'Name', 'full_name', 'name']);
                        const email = getValue(applicant, ['Email', 'email', 'email_address']);
                        const phone = getValue(applicant, ['Personal Number', 'Phone', 'phone', 'personal_number']);
                        const country = getValue(applicant, ['Country', 'country', 'preferred_country']);
                        const course = getValue(applicant, ['Course', 'course', 'preferred_course']);

                        return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${name}</td>
                    <td class="px-4 py-3 text-sm">${email}</td>
                    <td class="px-4 py-3 text-sm">${phone}</td>
                    <td class="px-4 py-3 text-sm">${country}</td>
                    <td class="px-4 py-3 text-sm">${course}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewApplicant(${applicantsData.indexOf(applicant)})" class="text-blue-600 hover:text-blue-800 text-xs">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
                    }).join('');
                }

                function closeStudentDetailModal() {
                    document.getElementById('studentDetailModal').classList.add('hidden');
                }

                function exportToCSV() {
                    if (applicantsData.length === 0) {
                        showNotification('‚ö†Ô∏è No data to export', 'warning');
                        return;
                    }

                    const headers = Object.keys(applicantsData[0]);
                    const csvContent = [
                        headers.join(','),
                        ...applicantsData.map(row =>
                            headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                        )
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `students-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);

                    showNotification('‚úÖ CSV exported successfully!', 'success');
                }
            </script>


            <!-- VISITORS PAGE -->
            <div id="visitors-page" class="page-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-user-friends text-indigo-600 mr-2"></i>Visitor Management
                    </h1>
                    
                    <div class="flex gap-2">
                        
    <button onclick="loadVisitors()" 
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow-md text-sm">
        <i class="fas fa-sync mr-2"></i>Refresh
    </button>
                        <button onclick="downloadVisitorsCSV()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-md text-sm">
                            <i class="fas fa-download mr-2"></i>CSV
                        </button>
                        <button onclick="exportVisitorsToSheets()"
                            class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 shadow-md text-sm">
                            <i class="fas fa-table mr-2"></i>Export to Sheets
                        </button>
                        <button onclick="openVisitorModal()"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md">
                            <i class="fas fa-plus mr-2"></i>New Visitor
                        </button>
                    </div>
                </div>

                <!-- Visitor Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-100 text-sm">Today's Visitors</p>
                                <h3 class="text-4xl font-bold mt-2" id="todayVisitors">0</h3>
                            </div>
                            <i class="fas fa-calendar-day text-3xl text-blue-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-purple-100 text-sm">This Week</p>
                                <h3 class="text-4xl font-bold mt-2" id="weekVisitors">0</h3>
                            </div>
                            <i class="fas fa-calendar-week text-3xl text-purple-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-100 text-sm">This Month</p>
                                <h3 class="text-4xl font-bold mt-2" id="monthVisitors">0</h3>
                            </div>
                            <i class="fas fa-calendar-alt text-3xl text-green-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-amber-100 text-sm">Follow-ups</p>
                                <h3 class="text-4xl font-bold mt-2" id="followUpVisitors">0</h3>
                            </div>
                            <i class="fas fa-bell text-3xl text-amber-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Visitor Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-chart-pie text-indigo-600 mr-2"></i>Visit Purpose Breakdown
                        </h3>
                        <div id="visitPurposeChart" class="space-y-2"></div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-chart-bar text-purple-600 mr-2"></i>Interest Level
                        </h3>
                        <div id="interestLevelChart" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Visitor Search & Filter -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="visitorSearch" placeholder="Search visitors..."
                            onkeyup="filterVisitors()"
                            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <select id="visitorPurposeFilter" onchange="filterVisitors()"
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Purposes</option>
                            <option value="Admission Inquiry">Admission Inquiry</option>
                            <option value="Course Information">Course Information</option>
                            <option value="IELTS Test">IELTS Test</option>
                            <option value="PTE Inquiry">PTE Inquiry</option>
                            <option value="Language Test">Language Test</option>
                            <option value="Visa Consultation">Visa Consultation</option>
                            <option value="Other">Other</option>
                        </select>
                        <select id="visitorInterestFilter" onchange="filterVisitors()"
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Interest Levels</option>
                            <option value="high">High Interest</option>
                            <option value="medium">Medium Interest</option>
                            <option value="low">Low Interest</option>
                        </select>
                    </div>
                </div>

                <!-- Visitors Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-indigo-50 to-purple-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Name
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                        Contact</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                        Purpose</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                        Interest</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Visit
                                        Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="visitorsTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                        <i class="fas fa-user-friends text-4xl mb-2 text-indigo-500"></i>
                                        <p class="font-semibold">No visitors recorded yet</p>
                                        <p class="text-sm">Click "New Visitor" to add your first visitor</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visitor Modal -->
            <div id="visitorModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-user-friends text-indigo-600 mr-2"></i>New Visitor
                        </h2>
                        <button onclick="closeVisitorModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form onsubmit="addVisitor(event)" class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Full Name *</label>
                                <input type="text" id="visitorName" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                    placeholder="John Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Phone *</label>
                                <input type="tel" id="visitorPhone" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                    placeholder="+977 98XXXXXXXX">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="visitorEmail"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                placeholder="email@example.com">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Purpose of Visit *</label>
                                <select id="visitorPurpose" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select...</option>
                                    <option value="Admission Inquiry">Admission Inquiry</option>
                                    <option value="Course Information">Course Information</option>
                                    <option value="IELTS Test">IELTS Test</option>
                                    <option value="PTE Inquiry">PTE Inquiry</option>
                                    <option value="Language Test">Language Test</option>
                                    <option value="Visa Consultation">Visa Consultation</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Interest Level *</label>
                                <select id="visitorInterest" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="high">üî¥ High Interest</option>
                                    <option value="medium" selected>üü° Medium Interest</option>
                                    <option value="low">üü¢ Low Interest</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Preferred Country</label>
                            <input type="text" id="visitorCountry"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                placeholder="Australia, Canada, UK...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Notes</label>
                            <textarea id="visitorNotes" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                placeholder="Additional information..."></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="visitorFollowUp"
                                        class="w-4 h-4 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm font-medium">Requires Follow-up</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Follow-up Date</label>
                                <input type="date" id="visitorFollowUpDate"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeVisitorModal()"
                                class="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm">Cancel</button>
                            <button type="submit"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                                <i class="fas fa-save mr-2"></i>Save Visitor
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Visitor Detail Modal -->
            <div id="visitorDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">Visitor Details</h2>
                        <button onclick="closeVisitorDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="visitorDetailContent" class="p-6"></div>
                </div>
            </div>

            <script>
                // ==================== VISITOR VARIABLES ====================
                let visitorsData = [];
                let filteredVisitors = [];

                // Google Sheets Configuration for Visitors
                const GOOGLE_SHEETS_CONFIG = {
                    SHEET_ID: '1WGcsbCmocmwItPC0XdaLkfb9UoN-OVYgTu1m0HglLm0',
                    API_KEY: 'AIzaSyB7fuRTNZqyb6juWEJeIzfyCb2Zh8yO6s4',
                    VISITOR_SHEET_NAME: 'Visitors',
                    WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbw-9P5Gw3TI6QKyxCjtbX1zKm0MWZCDtGBccomztrnQfKntkf4ABrv2_4RZ1sVBiQqrkg/exec'
                };

                // ==================== VISITOR FUNCTIONS ====================
                async function loadVisitors() {
                    if (!supabaseClient) {
                        console.warn('‚ö†Ô∏è Supabase not initialized');
                        return;
                    }
                    try {
                        console.log('üì• Loading visitors from Supabase...');

                        const { data, error } = await supabaseClient
                            .from('visitors')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) {
                            console.error('‚ùå Supabase error:', error);
                            throw error;
                        }

                        visitorsData = data || [];
                        filteredVisitors = [...visitorsData];

                        console.log('‚úÖ Loaded', visitorsData.length, 'visitors from Supabase');

                        // Update UI
                        displayVisitors();
                        updateVisitorStats();
                        updateVisitorCharts();

                    } catch (error) {
                        console.error('Error loading visitors:', error);
                        showNotification('‚ùå Error loading visitors: ' + error.message, 'error');
                    }
                }


                function displayVisitors() {
                    const tbody = document.getElementById('visitorsTableBody');
                    if (!tbody) return;

                    if (filteredVisitors.length === 0) {
                        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-user-friends text-4xl mb-2 text-indigo-500"></i>
                    <p class="font-semibold">No visitors found</p>
                </td>
            </tr>
        `;
                        return;
                    }

                    const interestIcons = { high: 'üî¥', medium: 'üü°', low: 'üü¢' };

                    tbody.innerHTML = filteredVisitors.map(visitor => `
        <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-3 text-sm font-semibold">${visitor.name || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">
                <div>${visitor.phone || 'N/A'}</div>
                <div class="text-xs text-gray-500">${visitor.email || ''}</div>
            </td>
            <td class="px-4 py-3 text-sm">${visitor.purpose || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 rounded text-xs">
                    ${interestIcons[visitor.interest] || ''} ${visitor.interest || 'N/A'}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${visitor.visit_date ? new Date(visitor.visit_date).toLocaleDateString() : new Date(visitor.created_at).toLocaleDateString()}</td>
            <td class="px-4 py-3 text-sm">
                ${visitor.follow_up ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"><i class="fas fa-bell mr-1"></i>Follow-up</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">Visited</span>'}
            </td>
            <td class="px-4 py-3 text-sm">
                <button onclick="viewVisitor(${visitor.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="deleteVisitor(${visitor.id})" class="text-red-600 hover:text-red-800" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
                }

                async function addVisitor(event) {
                    event.preventDefault();
                    if (!supabaseClient) {
                        showNotification('‚ö†Ô∏è Database not connected', 'error');
                        return;
                    }

                    const visitorData = {
                        name: document.getElementById('visitorName').value,
                        phone: document.getElementById('visitorPhone').value,
                        email: document.getElementById('visitorEmail').value,
                        purpose: document.getElementById('visitorPurpose').value,
                        interest: document.getElementById('visitorInterest').value,
                        country: document.getElementById('visitorCountry').value,
                        notes: document.getElementById('visitorNotes').value,
                        follow_up: document.getElementById('visitorFollowUp').checked,
                        follow_up_date: document.getElementById('visitorFollowUpDate').value,
                        visit_date: new Date().toISOString().split('T')[0],
                        created_at: new Date().toISOString()
                    };

                    try {
                        console.log('üíæ Saving visitor to Supabase...');
                        const { error } = await supabaseClient.from('visitors').insert([visitorData]);
                        if (error) throw error;
                        console.log('‚úÖ Saved to Supabase');

                        console.log('üì§ Syncing to Google Sheets...');
                        const sheetsSuccess = await saveVisitorToGoogleSheets(visitorData);

                        await loadVisitors();
                        updateAllStats();
                        closeVisitorModal();
                        event.target.reset();

                        if (sheetsSuccess) {
                            showNotification('‚úÖ Visitor saved to database & Google Sheets!', 'success');
                        } else {
                            showNotification('‚úÖ Visitor saved to database (Google Sheets sync may be pending)', 'success');
                        }
                    } catch (error) {
                        console.error('Error adding visitor:', error);
                        showNotification('‚ùå Error adding visitor: ' + error.message, 'error');
                    }
                }

                function viewVisitor(visitorId) {
                    const visitor = visitorsData.find(v => v.id === visitorId);
                    if (!visitor) return;

                    const interestIcons = { high: 'üî¥ High', medium: 'üü° Medium', low: 'üü¢ Low' };
                    const content = document.getElementById('visitorDetailContent');

                    content.innerHTML = `
        <div class="space-y-4">
            <div class="p-4 bg-indigo-50 rounded-lg">
                <h3 class="font-bold text-lg text-indigo-900">${visitor.name}</h3>
                <p class="text-sm text-indigo-600">${visitor.email || 'No email'}</p>
                <p class="text-sm text-indigo-600">${visitor.phone}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-gray-500 uppercase">Purpose</p>
                    <p class="font-semibold">${visitor.purpose}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Interest Level</p>
                    <p class="font-semibold">${interestIcons[visitor.interest]}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Visit Date</p>
                    <p class="font-semibold">${new Date(visitor.visit_date || visitor.created_at).toLocaleDateString()}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Preferred Country</p>
                    <p class="font-semibold">${visitor.country || 'Not specified'}</p>
                </div>
            </div>
            
            ${visitor.notes ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase mb-2">Notes</p>
                    <p class="text-sm">${visitor.notes}</p>
                </div>
            ` : ''}
            
            ${visitor.follow_up ? `
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-bell mr-2"></i>
                        Follow-up required ${visitor.follow_up_date ? 'on ' + new Date(visitor.follow_up_date).toLocaleDateString() : ''}
                    </p>
                </div>
            ` : ''}
        </div>
    `;

                    document.getElementById('visitorDetailModal').classList.remove('hidden');
                }

                async function deleteVisitor(visitorId) {
                    if (!confirm('Are you sure you want to delete this visitor?')) return;
                    if (!supabaseClient) return;

                    try {
                        const { error } = await supabaseClient.from('visitors').delete().eq('id', visitorId);
                        if (error) throw error;

                        await loadVisitors();
                        updateAllStats();
                        showNotification('‚úÖ Visitor deleted!', 'success');
                    } catch (error) {
                        console.error('Error deleting visitor:', error);
                        showNotification('‚ùå Error deleting visitor', 'error');
                    }
                }

                function filterVisitors() {
                    const searchTerm = document.getElementById('visitorSearch').value.toLowerCase();
                    const purposeFilter = document.getElementById('visitorPurposeFilter').value;
                    const interestFilter = document.getElementById('visitorInterestFilter').value;

                    filteredVisitors = visitorsData.filter(visitor => {
                        const matchesSearch = !searchTerm ||
                            (visitor.name && visitor.name.toLowerCase().includes(searchTerm)) ||
                            (visitor.phone && visitor.phone.includes(searchTerm)) ||
                            (visitor.email && visitor.email.toLowerCase().includes(searchTerm));

                        const matchesPurpose = !purposeFilter || visitor.purpose === purposeFilter;
                        const matchesInterest = !interestFilter || visitor.interest === interestFilter;

                        return matchesSearch && matchesPurpose && matchesInterest;
                    });

                    displayVisitors();
                }

                function updateVisitorStats() {
                    const today = new Date().toISOString().split('T')[0];
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);

                    const todayVisitors = visitorsData.filter(v =>
                        (v.visit_date || v.created_at).startsWith(today)
                    ).length;

                    const weekVisitors = visitorsData.filter(v =>
                        new Date(v.visit_date || v.created_at) >= weekAgo
                    ).length;

                    const monthVisitors = visitorsData.filter(v =>
                        new Date(v.visit_date || v.created_at) >= monthAgo
                    ).length;

                    const followUpVisitors = visitorsData.filter(v => v.follow_up).length;

                    document.getElementById('todayVisitors').textContent = todayVisitors;
                    document.getElementById('weekVisitors').textContent = weekVisitors;
                    document.getElementById('monthVisitors').textContent = monthVisitors;
                    document.getElementById('followUpVisitors').textContent = followUpVisitors;
                    document.getElementById('totalVisitors').textContent = visitorsData.length;
                }

                function updateVisitorCharts() {
                    // Purpose Chart
                    const purposeCount = {};
                    visitorsData.forEach(v => {
                        purposeCount[v.purpose] = (purposeCount[v.purpose] || 0) + 1;
                    });

                    const purposeChart = document.getElementById('visitPurposeChart');
                    if (purposeChart) {
                        if (Object.keys(purposeCount).length === 0) {
                            purposeChart.innerHTML = '<p class="text-gray-500 text-center py-4">No data yet</p>';
                        } else {
                            purposeChart.innerHTML = Object.entries(purposeCount).map(([purpose, count]) => {
                                const percentage = (count / visitorsData.length * 100).toFixed(1);
                                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm font-medium">${purpose}</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-600" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">${count}</span>
                        </div>
                    </div>
                `;
                            }).join('');
                        }
                    }

                    // Interest Level Chart
                    const interestCount = { high: 0, medium: 0, low: 0 };
                    visitorsData.forEach(v => {
                        if (v.interest) interestCount[v.interest]++;
                    });

                    const interestChart = document.getElementById('interestLevelChart');
                    if (interestChart) {
                        interestChart.innerHTML = `
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                    <span class="text-sm font-medium">üî¥ High Interest</span>
                    <span class="text-lg font-bold text-red-600">${interestCount.high}</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                    <span class="text-sm font-medium">üü° Medium Interest</span>
                    <span class="text-lg font-bold text-yellow-600">${interestCount.medium}</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <span class="text-sm font-medium">üü¢ Low Interest</span>
                    <span class="text-lg font-bold text-green-600">${interestCount.low}</span>
                </div>
            </div>
        `;
                    }
                }

                async function saveVisitorToGoogleSheets(visitorData) {
                    try {
                        const scriptUrl = GOOGLE_SHEETS_CONFIG.WEB_APP_URL;

                        const payload = {
                            action: 'addVisitor',
                            data: {
                                timestamp: new Date().toLocaleString(),
                                name: visitorData.name,
                                phone: visitorData.phone,
                                email: visitorData.email || '',
                                purpose: visitorData.purpose,
                                interest: visitorData.interest,
                                country: visitorData.country || '',
                                notes: visitorData.notes || '',
                                followUp: visitorData.follow_up ? 'Yes' : 'No',
                                followUpDate: visitorData.follow_up_date || '',
                                visitDate: visitorData.visit_date
                            }
                        };

                        const formData = new URLSearchParams();
                        formData.append('payload', JSON.stringify(payload));

                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            body: formData,
                            redirect: 'follow'
                        });

                        const text = await response.text();
                        console.log('‚úÖ Google Sheets response:', text);
                        return true;
                    } catch (error) {
                        console.error('‚ö†Ô∏è Google Sheets sync failed:', error);
                        return false;
                    }
                }

                async function exportVisitorsToSheets() {
                    if (visitorsData.length === 0) {
                        showNotification('‚ö†Ô∏è No visitors to export', 'warning');
                        return;
                    }

                    showNotification('üì§ Exporting to Google Sheets...', 'info');

                    try {
                        const scriptUrl = GOOGLE_SHEETS_CONFIG.WEB_APP_URL;

                        const payload = {
                            action: 'bulkAddVisitors',
                            data: visitorsData.map(v => ({
                                timestamp: new Date(v.created_at).toLocaleString(),
                                name: v.name,
                                phone: v.phone,
                                email: v.email || '',
                                purpose: v.purpose,
                                interest: v.interest,
                                country: v.country || '',
                                notes: v.notes || '',
                                followUp: v.follow_up ? 'Yes' : 'No',
                                followUpDate: v.follow_up_date || '',
                                visitDate: v.visit_date || new Date(v.created_at).toISOString().split('T')[0]
                            }))
                        };

                        const formData = new URLSearchParams();
                        formData.append('payload', JSON.stringify(payload));

                        await fetch(scriptUrl, {
                            method: 'POST',
                            body: formData,
                            redirect: 'follow'
                        });

                        showNotification('‚úÖ Exported to Google Sheets!', 'success');
                    } catch (error) {
                        console.error('Export error:', error);
                        showNotification('‚ùå Export failed: ' + error.message, 'error');
                    }
                }

                function downloadVisitorsCSV() {
                    if (visitorsData.length === 0) {
                        showNotification('‚ö†Ô∏è No visitors to export', 'warning');
                        return;
                    }

                    const headers = ['Timestamp', 'Name', 'Phone', 'Email', 'Purpose', 'Interest', 'Country', 'Notes', 'Follow-up', 'Follow-up Date', 'Visit Date'];

                    const csvRows = visitorsData.map(v => [
                        new Date(v.created_at).toLocaleString(),
                        v.name,
                        v.phone,
                        v.email || '',
                        v.purpose,
                        v.interest,
                        v.country || '',
                        (v.notes || '').replace(/"/g, '""'),
                        v.follow_up ? 'Yes' : 'No',
                        v.follow_up_date || '',
                        v.visit_date || new Date(v.created_at).toISOString().split('T')[0]
                    ]);

                    const csvContent = [
                        headers.join(','),
                        ...csvRows.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    link.setAttribute('href', url);
                    link.setAttribute('download', `visitors_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showNotification('‚úÖ CSV downloaded!', 'success');
                }

                // Modal Functions
                function openVisitorModal() {
                    document.getElementById('visitorModal').classList.remove('hidden');
                }

                function closeVisitorModal() {
                    document.getElementById('visitorModal').classList.add('hidden');
                }

                function closeVisitorDetailModal() {
                    document.getElementById('visitorDetailModal').classList.add('hidden');
                }
            </script>


            <!-- TASKS PAGE -->
            <div id="tasks-page" class="page-section">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Task Management</h1>
                    <button onclick="openTaskModal()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>New Task
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-6 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                        <h4 class="font-semibold text-yellow-700">To Do</h4>
                        <p class="text-3xl font-bold text-yellow-800 mt-2" id="todoCount">0</p>
                    </div>
                    <div class="p-6 bg-blue-50 rounded-xl border-l-4 border-blue-500">
                        <h4 class="font-semibold text-blue-700">In Progress</h4>
                        <p class="text-3xl font-bold text-blue-800 mt-2" id="inProgressCount">0</p>
                    </div>
                    <div class="p-6 bg-green-50 rounded-xl border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-700">Completed</h4>
                        <p class="text-3xl font-bold text-green-800 mt-2" id="doneCount">0</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">All Tasks</h3>
                    <div id="tasksContainer" class="space-y-3">
                        <p class="text-center text-gray-500 py-8">No tasks yet</p>
                    </div>
                </div>
            </div>

            <!-- Task Modal -->
            <div id="taskModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-tasks text-blue-600 mr-2"></i>Assign Task
                        </h2>
                        <button onclick="closeTaskModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form onsubmit="addTask(event)" class="p-6 space-y-4">

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-semibold text-blue-800 mb-3 text-sm">
                                <i class="fas fa-user-tag mr-2"></i>Assignee
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Name *</label>
                                    <input type="text" id="taskAssigneeName" required
                                        class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                        placeholder="Full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email *</label>
                                    <input type="email" id="taskAssigneeEmail" required
                                        class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                        placeholder="email@example.com">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm font-medium mb-2">Role/Position</label>
                                <input type="text" id="taskAssigneeRole"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                    placeholder="Position or department">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Task Title *</label>
                            <input type="text" id="taskTitle" required
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="Task title">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea id="taskDescription" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="Task details and requirements..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Related Student (Optional)</label>
                            <input type="text" id="taskRelatedStudent"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="Student name if applicable">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Priority *</label>
                                <select id="taskPriority" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                    <option value="low">üü¢ Low</option>
                                    <option value="medium" selected>üü° Medium</option>
                                    <option value="high">üî¥ High</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Due Date *</label>
                                <input type="date" id="taskDueDate" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeTaskModal()"
                                class="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm">Cancel</button>
                            <button type="submit"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-paper-plane mr-2"></i>Assign Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <script>
                // ==================== TASK FUNCTIONS ====================
                async function loadTasks() {
                    if (!supabaseClient) return;
                    try {
                        const { data, error } = await supabaseClient
                            .from('tasks')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        tasksData = data || [];
                        displayTasks();
                        updateTaskStats();
                        console.log('‚úÖ Loaded', tasksData.length, 'tasks from Supabase');
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                        showNotification('‚ùå Error loading tasks', 'error');
                    }
                }

                function displayTasks() {
                    const container = document.getElementById('tasksContainer');
                    if (!container) return;

                    if (tasksData.length === 0) {
                        container.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-tasks text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 font-semibold">No tasks yet</p>
                <p class="text-gray-400 text-sm">Click "New Task" to create your first task</p>
            </div>
        `;
                        return;
                    }

                    const priorityColors = {
                        low: 'bg-green-100 text-green-800 border-green-200',
                        medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                        high: 'bg-red-100 text-red-800 border-red-200'
                    };

                    const statusColors = {
                        todo: 'bg-gray-100 text-gray-800 border-gray-200',
                        inprogress: 'bg-blue-100 text-blue-800 border-blue-200',
                        done: 'bg-green-100 text-green-800 border-green-200'
                    };

                    const priorityIcons = {
                        low: 'üü¢',
                        medium: 'üü°',
                        high: 'üî¥'
                    };

                    container.innerHTML = tasksData.map(task => `
        <div class="p-5 bg-gradient-to-r from-gray-50 to-white rounded-xl border-l-4 ${task.priority === 'high' ? 'border-red-500' : task.priority === 'medium' ? 'border-yellow-500' : 'border-green-500'} shadow-sm hover:shadow-md transition">
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <h4 class="font-bold text-lg text-gray-800">${task.title}</h4>
                    <p class="text-sm text-gray-600 mt-1">${task.description || 'No description provided'}</p>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg border mb-3 text-sm">
                <div class="flex items-center mb-2">
                    <i class="fas fa-user text-blue-600 mr-2 w-5"></i>
                    <span class="font-semibold">${task.assignee_name}</span>
                </div>
                <div class="flex items-center mb-2">
                    <i class="fas fa-envelope text-gray-400 mr-2 w-5"></i>
                    <span class="text-gray-600">${task.assignee_email}</span>
                </div>
                ${task.assignee_role ? `
                <div class="flex items-center mb-2">
                    <i class="fas fa-briefcase text-gray-400 mr-2 w-5"></i>
                    <span class="text-gray-600">${task.assignee_role}</span>
                </div>
                ` : ''}
                ${task.related_student ? `
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-gray-400 mr-2 w-5"></i>
                    <span class="text-gray-600">${task.related_student}</span>
                </div>
                ` : ''}
            </div>
            
            <div class="flex flex-wrap gap-2 mb-3">
                <span class="px-3 py-1 rounded-full text-xs font-semibold border ${priorityColors[task.priority]}">
                    ${priorityIcons[task.priority]} ${task.priority.toUpperCase()}
                </span>
                <span class="px-3 py-1 rounded-full text-xs font-semibold border ${statusColors[task.status]}">
                    ${task.status === 'inprogress' ? 'IN PROGRESS' : task.status.toUpperCase()}
                </span>
                ${task.due_date ? `
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-calendar mr-1"></i>${new Date(task.due_date).toLocaleDateString()}
                </span>
                ` : ''}
            </div>
            
            <div class="flex gap-2 justify-end pt-3 border-t">
                <select onchange="updateTaskStatus(${task.id}, this.value)" class="px-3 py-2 border rounded-lg text-xs font-medium focus:ring-2 focus:ring-blue-500">
                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>üìã To Do</option>
                    <option value="inprogress" ${task.status === 'inprogress' ? 'selected' : ''}>‚öôÔ∏è In Progress</option>
                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>‚úÖ Done</option>
                </select>
                <button onclick="deleteTask(${task.id})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg text-xs hover:bg-red-200 font-medium">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
            </div>
        </div>
    `).join('');
                }

                async function addTask(event) {
                    event.preventDefault();
                    if (!supabaseClient) {
                        showNotification('‚ö†Ô∏è Database not connected', 'error');
                        return;
                    }

                    const taskData = {
                        // Remove the id field - let Supabase auto-generate it
                        assignee_name: document.getElementById('taskAssigneeName').value,
                        assignee_email: document.getElementById('taskAssigneeEmail').value,
                        assignee_role: document.getElementById('taskAssigneeRole').value,
                        title: document.getElementById('taskTitle').value,
                        description: document.getElementById('taskDescription').value,
                        related_student: document.getElementById('taskRelatedStudent').value,
                        priority: document.getElementById('taskPriority').value,
                        due_date: document.getElementById('taskDueDate').value,
                        status: 'todo',
                        created_at: new Date().toISOString()
                    };

                    try {
                        console.log('üíæ Saving task to Supabase...');
                        const { error } = await supabaseClient.from('tasks').insert([taskData]);
                        if (error) throw error;

                        console.log('‚úÖ Task saved to Supabase');

                        await loadTasks();
                        updateAllStats();
                        closeTaskModal();
                        event.target.reset();

                        // Try to send email notification
                        try {
                            await sendTaskEmail(taskData);
                            showNotification('‚úÖ Task assigned and email sent!', 'success');
                        } catch (emailError) {
                            console.error('Email send failed:', emailError);
                            showNotification('‚úÖ Task assigned (email notification failed)', 'warning');
                        }
                    } catch (error) {
                        console.error('Error adding task:', error);
                        showNotification('‚ùå Error creating task: ' + error.message, 'error');
                    }
                }

                async function updateTaskStatus(taskId, newStatus) {
                    if (!supabaseClient) return;
                    try {
                        const { error } = await supabaseClient
                            .from('tasks')
                            .update({
                                status: newStatus,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', taskId);

                        if (error) throw error;

                        await loadTasks();
                        updateAllStats();
                        showNotification('‚úÖ Task status updated!', 'success');
                    } catch (error) {
                        console.error('Error updating task:', error);
                        showNotification('‚ùå Error updating task', 'error');
                    }
                }

                async function deleteTask(taskId) {
                    if (!confirm('Are you sure you want to delete this task?')) return;
                    if (!supabaseClient) return;

                    try {
                        const { error } = await supabaseClient
                            .from('tasks')
                            .delete()
                            .eq('id', taskId);

                        if (error) throw error;

                        await loadTasks();
                        updateAllStats();
                        showNotification('‚úÖ Task deleted!', 'success');
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        showNotification('‚ùå Error deleting task', 'error');
                    }
                }

                function updateTaskStats() {
                    const todoCount = tasksData.filter(t => t.status === 'todo').length;
                    const inProgressCount = tasksData.filter(t => t.status === 'inprogress').length;
                    const doneCount = tasksData.filter(t => t.status === 'done').length;

                    const todoEl = document.getElementById('todoCount');
                    const inProgressEl = document.getElementById('inProgressCount');
                    const doneEl = document.getElementById('doneCount');
                    const pendingEl = document.getElementById('pendingTasks');

                    if (todoEl) todoEl.textContent = todoCount;
                    if (inProgressEl) inProgressEl.textContent = inProgressCount;
                    if (doneEl) doneEl.textContent = doneCount;
                    if (pendingEl) pendingEl.textContent = todoCount + inProgressCount;
                }

                // ==================== EMAIL FUNCTIONS FOR TASKS ====================
                async function sendTaskEmail(task) {
                    if (!EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID || !EMAILJS_PUBLIC_KEY) {
                        console.warn('‚ö†Ô∏è EmailJS not configured. Skipping email notification.');
                        throw new Error('EmailJS not configured');
                    }

                    try {
                        const result = await emailjs.send(
                            EMAILJS_SERVICE_ID,
                            EMAILJS_TEMPLATE_ID,
                            {
                                to_name: task.assignee_name,
                                to_email: task.assignee_email,
                                task_title: task.title,
                                task_description: task.description || 'No description provided',
                                task_priority: task.priority.toUpperCase(),
                                task_due_date: task.due_date ? new Date(task.due_date).toLocaleDateString() : 'Not set',
                                assignee_role: task.assignee_role || 'Not specified',
                                related_student: task.related_student || 'Not specified'
                            }
                        );
                        console.log('‚úÖ Email sent successfully:', result);
                        return result;
                    } catch (error) {
                        console.error('‚ùå Email error:', error);
                        throw error;
                    }
                }

                // Modal Functions
                function openTaskModal() {
                    document.getElementById('taskModal').classList.remove('hidden');
                    // Set minimum date to today
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('taskDueDate').setAttribute('min', today);
                }

                function closeTaskModal() {
                    document.getElementById('taskModal').classList.add('hidden');
                }
            </script>
            <script>
                // Update the existing updateAllStats function to include task stats
                function updateAllStats() {
                    // Students
                    const totalApplicants = document.getElementById('totalApplicants');
                    if (totalApplicants) totalApplicants.textContent = applicantsData.length;

                    // Visitors
                    const totalVisitors = document.getElementById('totalVisitors');
                    if (totalVisitors) totalVisitors.textContent = visitorsData.length;

                    // Tasks
                    const todoCount = tasksData.filter(t => t.status === 'todo').length;
                    const inProgressCount = tasksData.filter(t => t.status === 'inprogress').length;
                    const doneCount = tasksData.filter(t => t.status === 'done').length;

                    const pendingTasks = document.getElementById('pendingTasks');
                    const todoCountEl = document.getElementById('todoCount');
                    const inProgressCountEl = document.getElementById('inProgressCount');
                    const doneCountEl = document.getElementById('doneCount');

                    if (pendingTasks) pendingTasks.textContent = todoCount + inProgressCount;
                    if (todoCountEl) todoCountEl.textContent = todoCount;
                    if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;
                    if (doneCountEl) doneCountEl.textContent = doneCount;

                    // Classes
                    const totalClasses = document.getElementById('totalClasses');
                    if (totalClasses) totalClasses.textContent = classesData.length;

                    // Settings
                    const settingsStudentCount = document.getElementById('settingsStudentCount');
                    const settingsTaskCount = document.getElementById('settingsTaskCount');

                    if (settingsStudentCount) settingsStudentCount.textContent = applicantsData.length;
                    if (settingsTaskCount) settingsTaskCount.textContent = tasksData.length;

                    // Last Updated
                    const lastUpdated = document.getElementById('lastUpdated');
                    if (lastUpdated) {
                        const now = new Date();
                        lastUpdated.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                }
            </script>

            <!-- Appointment Modal -->

            <!-- APPOINTMENTS PAGE -->
            <div id="appointments-page" class="page-section">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-calendar text-blue-600 mr-2"></i>Appointments
                    </h1>
                    <button onclick="openAppointmentModal()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>New Appointment
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-100 text-sm">Today</p>
                                <h3 class="text-4xl font-bold mt-2" id="todayAppointments">0</h3>
                            </div>
                            <i class="fas fa-calendar-day text-3xl text-blue-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-purple-100 text-sm">This Week</p>
                                <h3 class="text-4xl font-bold mt-2" id="weekAppointments">0</h3>
                            </div>
                            <i class="fas fa-calendar-week text-3xl text-purple-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-100 text-sm">This Month</p>
                                <h3 class="text-4xl font-bold mt-2" id="monthAppointments">0</h3>
                            </div>
                            <i class="fas fa-calendar-alt text-3xl text-green-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-indigo-100 text-sm">Upcoming</p>
                                <h3 class="text-4xl font-bold mt-2" id="upcomingAppointmentsCount">0</h3>
                            </div>
                            <i class="fas fa-clock text-3xl text-indigo-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterAppointments('all')"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
                            All
                        </button>
                        <button onclick="filterAppointments('upcoming')"
                            class="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg text-sm font-medium">
                            Upcoming
                        </button>
                        <button onclick="filterAppointments('past')"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
                            Past
                        </button>
                    </div>
                </div>

                <!-- Appointments Container -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">All Appointments</h3>
                    <div id="appointmentsContainer" class="space-y-3">
                        <p class="text-center text-gray-500 py-8">No appointments yet</p>
                    </div>
                </div>
            </div>

            <!-- CLASSES PAGE -->
            <div id="classes-page" class="page-section">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-book text-green-600 mr-2"></i>Classes
                    </h1>
                    <button onclick="openClassModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>New Class
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-100 text-sm">Total Classes</p>
                                <h3 class="text-4xl font-bold mt-2" id="totalClassesCount">0</h3>
                            </div>
                            <i class="fas fa-book text-3xl text-green-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-100 text-sm">Total Enrolled</p>
                                <h3 class="text-4xl font-bold mt-2" id="totalEnrolled">0</h3>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-purple-100 text-sm">Instructors</p>
                                <h3 class="text-4xl font-bold mt-2" id="totalInstructors">0</h3>
                            </div>
                            <i class="fas fa-chalkboard-teacher text-3xl text-purple-200"></i>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 text-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-amber-100 text-sm">Avg. Enrollment</p>
                                <h3 class="text-4xl font-bold mt-2" id="avgEnrollment">0</h3>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-amber-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="classSearch" placeholder="Search classes..." onkeyup="filterClasses()"
                            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                        <select id="classInstructorFilter" onchange="filterClasses()"
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">All Instructors</option>
                        </select>
                        <button onclick="filterClasses('all')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Show All
                        </button>
                    </div>
                </div>

                <!-- Classes Grid -->
                <div id="classesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 font-semibold">No classes yet</p>
                        <p class="text-gray-400 text-sm">Click "New Class" to add your first class</p>
                    </div>
                </div>
            </div>

            <div id="appointmentModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-md">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-calendar-plus text-blue-600 mr-2"></i>New Appointment
                        </h2>
                        <button onclick="closeAppointmentModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form onsubmit="addAppointment(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Student/Client Name *</label>
                            <input type="text" id="appointmentStudent" required
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="Full name">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Contact Number</label>
                            <input type="tel" id="appointmentPhone"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="+977 98XXXXXXXX">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="appointmentEmail"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="email@example.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Purpose *</label>
                            <select id="appointmentPurpose" required
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="">Select purpose...</option>
                                <option value="Consultation">General Consultation</option>
                                <option value="Document Review">Document Review</option>
                                <option value="IELTS/PTE Counseling">IELTS/PTE Counseling</option>
                                <option value="Visa Interview Prep">Visa Interview Prep</option>
                                <option value="Application Submission">Application Submission</option>
                                <option value="Follow-up Meeting">Follow-up Meeting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Date *</label>
                                <input type="date" id="appointmentDate" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Time *</label>
                                <input type="time" id="appointmentTime" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Duration</label>
                            <select id="appointmentDuration"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Notes</label>
                            <textarea id="appointmentNotes" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="Additional notes or requirements..."></textarea>
                        </div>

                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="appointmentReminder"
                                class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <label for="appointmentReminder" class="text-sm font-medium">Send reminder
                                notification</label>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeAppointmentModal()"
                                class="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm">Cancel</button>
                            <button type="submit"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-calendar-check mr-2"></i>Schedule
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Appointment Detail Modal -->
            <div id="appointmentDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-lg">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold">Appointment Details</h2>
                        <button onclick="closeAppointmentDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="appointmentDetailContent" class="p-6"></div>
                </div>
            </div>

            <script>
                // ==================== APPOINTMENT FUNCTIONS ====================
                let appointmentFilter = 'all'; // Track current filter

                async function loadAppointments() {
                    if (!supabaseClient) return;
                    try {
                        const { data, error } = await supabaseClient
                            .from('appointments')
                            .select('*')
                            .order('date', { ascending: true });

                        if (error) throw error;

                        appointmentsData = data || [];
                        displayAppointments();
                        updateAppointmentStats();
                        console.log('‚úÖ Loaded', appointmentsData.length, 'appointments from Supabase');
                    } catch (error) {
                        console.error('Error loading appointments:', error);
                        showNotification('‚ùå Error loading appointments', 'error');
                    }
                }

                function displayAppointments() {
                    const container = document.getElementById('appointmentsContainer');
                    if (!container) return;

                    // Filter appointments based on current filter
                    let filteredAppointments = [...appointmentsData];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (appointmentFilter === 'upcoming') {
                        filteredAppointments = appointmentsData.filter(apt => {
                            const aptDate = new Date(apt.date);
                            aptDate.setHours(0, 0, 0, 0);
                            return aptDate >= today;
                        });
                    } else if (appointmentFilter === 'past') {
                        filteredAppointments = appointmentsData.filter(apt => {
                            const aptDate = new Date(apt.date);
                            aptDate.setHours(0, 0, 0, 0);
                            return aptDate < today;
                        });
                    }

                    if (filteredAppointments.length === 0) {
                        container.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 font-semibold">No ${appointmentFilter !== 'all' ? appointmentFilter : ''} appointments</p>
                <p class="text-gray-400 text-sm">Click "New Appointment" to schedule one</p>
            </div>
        `;
                        return;
                    }

                    container.innerHTML = filteredAppointments.map(apt => {
                        const aptDate = new Date(apt.date);
                        const isPast = aptDate < today;
                        const isToday = aptDate.toDateString() === today.toDateString();

                        return `
        <div class="p-5 bg-gradient-to-r ${isPast ? 'from-gray-50 to-gray-100' : 'from-blue-50 to-white'} rounded-xl border-l-4 ${isToday ? 'border-green-500' : isPast ? 'border-gray-400' : 'border-blue-500'} shadow-sm hover:shadow-md transition">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <h4 class="font-bold text-lg text-gray-800">${apt.student}</h4>
                        ${isToday ? '<span class="px-2 py-1 bg-green-500 text-white text-xs rounded-full font-semibold">TODAY</span>' : ''}
                        ${isPast ? '<span class="px-2 py-1 bg-gray-400 text-white text-xs rounded-full font-semibold">PAST</span>' : ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-3">
                        <i class="fas fa-clipboard-list text-purple-600 mr-1"></i>
                        ${apt.purpose || 'General Consultation'}
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center">
                            <i class="fas fa-calendar text-blue-600 mr-2 w-5"></i>
                            <span>${new Date(apt.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-purple-600 mr-2 w-5"></i>
                            <span>${apt.time}</span>
                            ${apt.duration ? ` <span class="text-gray-500 ml-1">(${apt.duration} min)</span>` : ''}
                        </div>
                        ${apt.phone ? `
                        <div class="flex items-center">
                            <i class="fas fa-phone text-green-600 mr-2 w-5"></i>
                            <span>${apt.phone}</span>
                        </div>
                        ` : ''}
                        ${apt.email ? `
                        <div class="flex items-center">
                            <i class="fas fa-envelope text-orange-600 mr-2 w-5"></i>
                            <span class="truncate">${apt.email}</span>
                        </div>
                        ` : ''}
                    </div>
                    ${apt.notes ? `
                    <div class="mt-3 p-3 bg-white rounded-lg border">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Notes</p>
                        <p class="text-sm text-gray-700">${apt.notes}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
            <div class="flex gap-2 justify-end mt-4 pt-3 border-t">
                <button onclick="viewAppointment(${apt.id})" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-xs hover:bg-blue-200 font-medium">
                    <i class="fas fa-eye mr-1"></i>View
                </button>
                ${!isPast ? `
                <button onclick="editAppointment(${apt.id})" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-xs hover:bg-green-200 font-medium">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
                ` : ''}
                <button onclick="deleteAppointment(${apt.id})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg text-xs hover:bg-red-200 font-medium">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
            </div>
        </div>
    `}).join('');

                    displayNextAppointment();
                }

                async function addAppointment(event) {
                    event.preventDefault();
                    if (!supabaseClient) {
                        showNotification('‚ö†Ô∏è Database not connected', 'error');
                        return;
                    }

                    const appointmentData = {
                        // Remove id field
                        student: document.getElementById('appointmentStudent').value,
                        phone: document.getElementById('appointmentPhone').value,
                        email: document.getElementById('appointmentEmail').value,
                        purpose: document.getElementById('appointmentPurpose').value,
                        date: document.getElementById('appointmentDate').value,
                        time: document.getElementById('appointmentTime').value,
                        duration: document.getElementById('appointmentDuration').value,
                        notes: document.getElementById('appointmentNotes').value,
                        reminder: document.getElementById('appointmentReminder').checked,
                        created_at: new Date().toISOString()
                    };

                    try {
                        console.log('üíæ Saving appointment to Supabase...');
                        const { error } = await supabaseClient.from('appointments').insert([appointmentData]);
                        if (error) throw error;

                        console.log('‚úÖ Appointment saved to Supabase');

                        await loadAppointments();
                        updateAllStats();
                        closeAppointmentModal();
                        event.target.reset();
                        showNotification('‚úÖ Appointment scheduled successfully!', 'success');
                    } catch (error) {
                        console.error('Error adding appointment:', error);
                        showNotification('‚ùå Error scheduling appointment: ' + error.message, 'error');
                    }
                }

                function viewAppointment(aptId) {
                    const appointment = appointmentsData.find(a => a.id === aptId);
                    if (!appointment) return;

                    const content = document.getElementById('appointmentDetailContent');
                    const aptDate = new Date(appointment.date);
                    const isPast = aptDate < new Date();

                    content.innerHTML = `
        <div class="space-y-4">
            <div class="p-4 ${isPast ? 'bg-gray-50' : 'bg-blue-50'} rounded-lg">
                <h3 class="font-bold text-lg text-gray-900">${appointment.student}</h3>
                <p class="text-sm text-gray-600">${appointment.purpose || 'General Consultation'}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Date</p>
                    <p class="font-semibold">${aptDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Time</p>
                    <p class="font-semibold">${appointment.time}</p>
                </div>
                ${appointment.duration ? `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Duration</p>
                    <p class="font-semibold">${appointment.duration} minutes</p>
                </div>
                ` : ''}
                ${appointment.phone ? `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Phone</p>
                    <p class="font-semibold">${appointment.phone}</p>
                </div>
                ` : ''}
                ${appointment.email ? `
                <div class="p-3 bg-gray-50 rounded-lg col-span-2">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Email</p>
                    <p class="font-semibold">${appointment.email}</p>
                </div>
                ` : ''}
            </div>
            
            ${appointment.notes ? `
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-500 uppercase font-semibold mb-2">Notes</p>
                <p class="text-sm">${appointment.notes}</p>
            </div>
            ` : ''}
            
            ${appointment.reminder ? `
            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-bell mr-2"></i>
                    Reminder notification enabled
                </p>
            </div>
            ` : ''}
        </div>
    `;

                    document.getElementById('appointmentDetailModal').classList.remove('hidden');
                }

                async function deleteAppointment(aptId) {
                    if (!confirm('Are you sure you want to delete this appointment?')) return;
                    if (!supabaseClient) return;

                    try {
                        const { error } = await supabaseClient
                            .from('appointments')
                            .delete()
                            .eq('id', aptId);

                        if (error) throw error;

                        await loadAppointments();
                        updateAllStats();
                        showNotification('‚úÖ Appointment deleted!', 'success');
                    } catch (error) {
                        console.error('Error deleting appointment:', error);
                        showNotification('‚ùå Error deleting appointment', 'error');
                    }
                }

                function editAppointment(aptId) {
                    // Optional: Implement edit functionality
                    showNotification('‚ÑπÔ∏è Edit feature coming soon', 'info');
                }

                function filterAppointments(filter) {
                    appointmentFilter = filter;
                    displayAppointments();
                }

                function updateAppointmentStats() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const weekFromNow = new Date();
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    weekFromNow.setHours(23, 59, 59, 999);

                    const monthFromNow = new Date();
                    monthFromNow.setMonth(monthFromNow.getMonth() + 1);
                    monthFromNow.setHours(23, 59, 59, 999);

                    const todayApts = appointmentsData.filter(a => {
                        const aptDate = new Date(a.date);
                        aptDate.setHours(0, 0, 0, 0);
                        return aptDate.getTime() === today.getTime();
                    }).length;

                    const weekApts = appointmentsData.filter(a => {
                        const aptDate = new Date(a.date);
                        return aptDate >= today && aptDate <= weekFromNow;
                    }).length;

                    const monthApts = appointmentsData.filter(a => {
                        const aptDate = new Date(a.date);
                        return aptDate >= today && aptDate <= monthFromNow;
                    }).length;

                    const upcomingApts = appointmentsData.filter(a => {
                        const aptDate = new Date(a.date);
                        aptDate.setHours(0, 0, 0, 0);
                        return aptDate >= today;
                    }).length;

                    const completedApts = appointmentsData.filter(a => {
                        const aptDate = new Date(a.date);
                        aptDate.setHours(0, 0, 0, 0);
                        return aptDate < today;
                    }).length;

                    // Update elements
                    const elements = {
                        todayAppointments: todayApts,
                        weekAppointments: weekApts,
                        monthAppointments: monthApts,
                        totalAppointments: appointmentsData.length,
                        upcomingAppointmentsCount: upcomingApts,
                        completedAppointments: completedApts
                    };

                    Object.entries(elements).forEach(([id, value]) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = value;
                    });
                }

                function displayNextAppointment() {
                    const container = document.getElementById('nextAppointmentCard');
                    if (!container) return;

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const upcomingAppointments = appointmentsData
                        .filter(apt => new Date(apt.date) >= today)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (upcomingAppointments.length === 0) {
                        container.innerHTML = '<p class="text-sm opacity-75">No upcoming appointments</p>';
                        return;
                    }

                    const next = upcomingAppointments[0];
                    const aptDate = new Date(next.date);

                    container.innerHTML = `
        <div>
            <p class="font-bold text-lg mb-1">${next.student}</p>
            <p class="text-sm opacity-90 mb-2">${next.purpose || 'Consultation'}</p>
            <div class="flex items-center gap-2 text-sm">
                <i class="fas fa-calendar"></i>
                <span>${aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                <i class="fas fa-clock ml-2"></i>
                <span>${next.time}</span>
            </div>
        </div>
    `;
                }

                // Display upcoming appointments on dashboard
                function displayUpcomingAppointments() {
                    const container = document.getElementById('upcomingAppointments');
                    if (!container) return;

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const upcoming = appointmentsData
                        .filter(apt => new Date(apt.date) >= today)
                        .sort((a, b) => new Date(a.date) - new Date(b.date))
                        .slice(0, 5);

                    if (upcoming.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming appointments</p>';
                        return;
                    }

                    container.innerHTML = upcoming.map(apt => {
                        const aptDate = new Date(apt.date);
                        const isToday = aptDate.toDateString() === new Date().toDateString();

                        return `
        <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg transition cursor-pointer" onclick="viewAppointment(${apt.id})">
            <div class="w-12 h-12 ${isToday ? 'bg-green-500' : 'bg-blue-500'} rounded-full flex items-center justify-center">
                <i class="fas fa-calendar text-white"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold">${apt.student}</p>
                <p class="text-xs text-gray-500">${apt.purpose || 'Consultation'}</p>
                <p class="text-xs text-gray-400">${aptDate.toLocaleDateString()} at ${apt.time}</p>
            </div>
            ${isToday ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-semibold">Today</span>' : ''}
        </div>
    `}).join('');
                }

                // Modal Functions
                function openAppointmentModal() {
                    document.getElementById('appointmentModal').classList.remove('hidden');
                    // Set minimum date to today
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('appointmentDate').setAttribute('min', today);
                }

                function closeAppointmentModal() {
                    document.getElementById('appointmentModal').classList.add('hidden');
                }

                function closeAppointmentDetailModal() {
                    document.getElementById('appointmentDetailModal').classList.add('hidden');
                }
            </script>

            <!-- Class Modal -->
            <div id="classModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-book-medical text-green-600 mr-2"></i>
                            <span id="classModalTitle">Add New Class</span>
                        </h2>
                        <button onclick="closeClassModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form onsubmit="addClass(event)" class="p-6 space-y-4">
                        <input type="hidden" id="classEditId" value="">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Class Name *</label>
                                <input type="text" id="className" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="IELTS Preparation">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Class Code</label>
                                <input type="text" id="classCode"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="IELTS-101">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Instructor *</label>
                                <input type="text" id="classInstructor" required
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="John Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Instructor Email</label>
                                <input type="email" id="classInstructorEmail"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="instructor@example.com">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea id="classDescription" rows="3"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                placeholder="Class description and objectives..."></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Schedule</label>
                                <input type="text" id="classSchedule"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="Mon, Wed, Fri">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Time</label>
                                <input type="text" id="classTime"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="10:00 AM - 12:00 PM">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Duration</label>
                                <input type="text" id="classDuration"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="2 hours">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Date</label>
                                <input type="date" id="classStartDate"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">End Date</label>
                                <input type="date" id="classEndDate"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Room/Location</label>
                                <input type="text" id="classRoom"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="Room 101">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Enrolled Students</label>
                                <input type="number" id="classEnrolled" min="0"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    value="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Capacity</label>
                                <input type="number" id="classCapacity" min="1"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="25">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fee</label>
                                <input type="text" id="classFee"
                                    class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                    placeholder="Rs. 15,000">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select id="classStatus"
                                class="w-full px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                <option value="active">Active</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="classOnline" class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <label for="classOnline" class="text-sm font-medium">Online Class</label>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeClassModal()"
                                class="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm">Cancel</button>
                            <button type="submit"
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-save mr-2"></i>Save Class
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Class Detail Modal -->
            <div id="classDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                    <div class="border-b px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
                        <h2 class="text-xl font-bold">Class Details</h2>
                        <button onclick="closeClassDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="classDetailContent" class="p-6"></div>
                </div>
            </div>

            <script>
                // ==================== CLASS FUNCTIONS ====================
                let filteredClasses = [];
                let classFilter = 'all';

                async function loadClasses() {
                    if (!supabaseClient) return;
                    try {
                        const { data, error } = await supabaseClient
                            .from('classes')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        classesData = data || [];
                        filteredClasses = [...classesData];
                        displayClasses();
                        updateClassStats();
                        updateInstructorFilter();
                        console.log('‚úÖ Loaded', classesData.length, 'classes from Supabase');
                    } catch (error) {
                        console.error('Error loading classes:', error);
                        showNotification('‚ùå Error loading classes', 'error');
                    }
                }

                function displayClasses() {
                    const container = document.getElementById('classesContainer');
                    if (!container) return;

                    if (filteredClasses.length === 0) {
                        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 font-semibold">No classes found</p>
                <p class="text-gray-400 text-sm">Try adjusting your search or filters</p>
            </div>
        `;
                        return;
                    }

                    const statusColors = {
                        active: 'bg-green-100 text-green-800 border-green-200',
                        upcoming: 'bg-blue-100 text-blue-800 border-blue-200',
                        completed: 'bg-gray-100 text-gray-800 border-gray-200',
                        cancelled: 'bg-red-100 text-red-800 border-red-200'
                    };

                    const statusIcons = {
                        active: 'üü¢',
                        upcoming: 'üîµ',
                        completed: '‚ö™',
                        cancelled: 'üî¥'
                    };

                    container.innerHTML = filteredClasses.map(cls => {
                        const enrollmentPercentage = cls.capacity ? (cls.enrolled / cls.capacity * 100).toFixed(0) : 0;
                        const isFull = cls.capacity && cls.enrolled >= cls.capacity;

                        return `
        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition overflow-hidden">
            <!-- Header with Status -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-4 text-white">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-lg">${cls.name}</h3>
                    <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs font-semibold">
                        ${statusIcons[cls.status] || '‚ö™'} ${(cls.status || 'active').toUpperCase()}
                    </span>
                </div>
                ${cls.code ? `<p class="text-sm opacity-90">${cls.code}</p>` : ''}
            </div>
            
            <!-- Body -->
            <div class="p-5 space-y-4">
                <!-- Instructor -->
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-green-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs text-gray-500">Instructor</p>
                        <p class="font-semibold text-sm">${cls.instructor || 'TBA'}</p>
                    </div>
                </div>
                
                <!-- Description -->
                ${cls.description ? `
                <p class="text-sm text-gray-600 line-clamp-2">${cls.description}</p>
                ` : ''}
                
                <!-- Schedule Info -->
                <div class="grid grid-cols-2 gap-3 text-sm">
                    ${cls.schedule ? `
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-blue-600 mr-2"></i>
                        <span class="text-gray-700">${cls.schedule}</span>
                    </div>
                    ` : ''}
                    ${cls.time ? `
                    <div class="flex items-center">
                        <i class="fas fa-clock text-purple-600 mr-2"></i>
                        <span class="text-gray-700">${cls.time}</span>
                    </div>
                    ` : ''}
                    ${cls.duration ? `
                    <div class="flex items-center">
                        <i class="fas fa-hourglass-half text-amber-600 mr-2"></i>
                        <span class="text-gray-700">${cls.duration}</span>
                    </div>
                    ` : ''}
                    ${cls.room ? `
                    <div class="flex items-center">
                        <i class="fas fa-door-open text-indigo-600 mr-2"></i>
                        <span class="text-gray-700">${cls.room}</span>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Enrollment Progress -->
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">Enrollment</span>
                        <span class="font-semibold ${isFull ? 'text-red-600' : 'text-green-600'}">
                            ${cls.enrolled || 0}${cls.capacity ? ` / ${cls.capacity}` : ''} students
                        </span>
                    </div>
                    ${cls.capacity ? `
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${isFull ? 'bg-red-500' : 'bg-green-500'} transition-all" style="width: ${Math.min(enrollmentPercentage, 100)}%"></div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Tags -->
                <div class="flex flex-wrap gap-2">
                    ${cls.online ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium"><i class="fas fa-wifi mr-1"></i>Online</span>' : ''}
                    ${cls.fee ? `<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full font-medium"><i class="fas fa-money-bill mr-1"></i>${cls.fee}</span>` : ''}
                    ${isFull ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-medium">Full</span>' : ''}
                </div>
            </div>
            
            <!-- Footer Actions -->
            <div class="border-t p-4 bg-gray-50 flex gap-2">
                <button onclick="viewClass(${cls.id})" class="flex-1 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 font-medium">
                    <i class="fas fa-eye mr-1"></i>View
                </button>
                <button onclick="editClass(${cls.id})" class="flex-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200 font-medium">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
                <button onclick="deleteClass(${cls.id})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200 font-medium">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `}).join('');
                }

                async function addClass(event) {
                    event.preventDefault();
                    if (!supabaseClient) {
                        showNotification('‚ö†Ô∏è Database not connected', 'error');
                        return;
                    }

                    const editId = document.getElementById('classEditId').value;

                    const classData = {
                        // Remove id field for new classes
                        name: document.getElementById('className').value,
                        code: document.getElementById('classCode').value,
                        instructor: document.getElementById('classInstructor').value,
                        instructor_email: document.getElementById('classInstructorEmail').value,
                        description: document.getElementById('classDescription').value,
                        schedule: document.getElementById('classSchedule').value,
                        time: document.getElementById('classTime').value,
                        duration: document.getElementById('classDuration').value,
                        start_date: document.getElementById('classStartDate').value,
                        end_date: document.getElementById('classEndDate').value,
                        room: document.getElementById('classRoom').value,
                        enrolled: parseInt(document.getElementById('classEnrolled').value) || 0,
                        capacity: parseInt(document.getElementById('classCapacity').value) || null,
                        fee: document.getElementById('classFee').value,
                        status: document.getElementById('classStatus').value,
                        online: document.getElementById('classOnline').checked,
                        updated_at: new Date().toISOString()
                    };

                    try {
                        if (editId) {
                            // Update existing class
                            const { error } = await supabaseClient
                                .from('classes')
                                .update(classData)
                                .eq('id', editId);

                            if (error) throw error;
                            showNotification('‚úÖ Class updated successfully!', 'success');
                        } else {
                            // Add new class - don't include id
                            classData.created_at = new Date().toISOString();
                            const { error } = await supabaseClient.from('classes').insert([classData]);
                            if (error) throw error;
                            showNotification('‚úÖ Class added successfully!', 'success');
                        }

                        await loadClasses();
                        updateAllStats();
                        closeClassModal();
                        event.target.reset();
                        document.getElementById('classEditId').value = '';
                    } catch (error) {
                        console.error('Error saving class:', error);
                        showNotification('‚ùå Error saving class: ' + error.message, 'error');
                    }
                }

                function viewClass(classId) {
                    const cls = classesData.find(c => c.id === classId);
                    if (!cls) return;

                    const content = document.getElementById('classDetailContent');
                    const enrollmentPercentage = cls.capacity ? (cls.enrolled / cls.capacity * 100).toFixed(0) : 0;

                    content.innerHTML = `
        <div class="space-y-6">
            <!-- Header -->
            <div class="p-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl">
                <h3 class="font-bold text-2xl mb-2">${cls.name}</h3>
                ${cls.code ? `<p class="text-green-100">${cls.code}</p>` : ''}
                <div class="mt-4 flex gap-2 flex-wrap">
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold">
                        ${cls.status ? cls.status.toUpperCase() : 'ACTIVE'}
                    </span>
                    ${cls.online ? '<span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold"><i class="fas fa-wifi mr-1"></i>Online</span>' : ''}
                </div>
            </div>
            
            <!-- Description -->
            ${cls.description ? `
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-700">${cls.description}</p>
            </div>
            ` : ''}
            
            <!-- Instructor Info -->
            <div class="p-4 bg-blue-50 rounded-lg">
                <h4 class="font-semibold mb-3 flex items-center">
                    <i class="fas fa-chalkboard-teacher text-blue-600 mr-2"></i>
                    Instructor Information
                </h4>
                <div class="space-y-2">
                    <p class="text-sm"><span class="font-medium">Name:</span> ${cls.instructor || 'TBA'}</p>
                    ${cls.instructor_email ? `<p class="text-sm"><span class="font-medium">Email:</span> ${cls.instructor_email}</p>` : ''}
                </div>
            </div>
            
            <!-- Schedule Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${cls.schedule ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Schedule</p>
                    <p class="font-semibold">${cls.schedule}</p>
                </div>
                ` : ''}
                ${cls.time ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Time</p>
                    <p class="font-semibold">${cls.time}</p>
                </div>
                ` : ''}
                ${cls.duration ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Duration</p>
                    <p class="font-semibold">${cls.duration}</p>
                </div>
                ` : ''}
                ${cls.room ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Room/Location</p>
                    <p class="font-semibold">${cls.room}</p>
                </div>
                ` : ''}
                ${cls.start_date ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Start Date</p>
                    <p class="font-semibold">${new Date(cls.start_date).toLocaleDateString()}</p>
                </div>
                ` : ''}
                ${cls.end_date ? `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">End Date</p>
                    <p class="font-semibold">${new Date(cls.end_date).toLocaleDateString()}</p>
                </div>
                ` : ''}
                ${cls.fee ? `
                <div class="p-4 bg-amber-50 rounded-lg">
                    <p class="text-xs text-amber-700 uppercase font-semibold mb-1">Fee</p>
                    <p class="font-semibold text-amber-800">${cls.fee}</p>
                </div>
                ` : ''}
            </div>
            
            <!-- Enrollment -->
            <div class="p-4 bg-green-50 rounded-lg">
                <h4 class="font-semibold mb-3">Enrollment Status</h4>
                <div class="flex justify-between mb-2">
                    <span>Students Enrolled:</span>
                    <span class="font-bold text-green-700">${cls.enrolled || 0}${cls.capacity ? ` / ${cls.capacity}` : ''}</span>
                </div>
                ${cls.capacity ? `
                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500" style="width: ${Math.min(enrollmentPercentage, 100)}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">${enrollmentPercentage}% capacity</p>
                ` : ''}
            </div>
        </div>
    `;

                    document.getElementById('classDetailModal').classList.remove('hidden');
                }

                function editClass(classId) {
                    const cls = classesData.find(c => c.id === classId);
                    if (!cls) return;

                    // Populate form fields
                    document.getElementById('classEditId').value = cls.id;
                    document.getElementById('className').value = cls.name || '';
                    document.getElementById('classCode').value = cls.code || '';
                    document.getElementById('classInstructor').value = cls.instructor || '';
                    document.getElementById('classInstructorEmail').value = cls.instructor_email || '';
                    document.getElementById('classDescription').value = cls.description || '';
                    document.getElementById('classSchedule').value = cls.schedule || '';
                    document.getElementById('classTime').value = cls.time || '';
                    document.getElementById('classDuration').value = cls.duration || '';
                    document.getElementById('classStartDate').value = cls.start_date || '';
                    document.getElementById('classEndDate').value = cls.end_date || '';
                    document.getElementById('classRoom').value = cls.room || '';
                    document.getElementById('classEnrolled').value = cls.enrolled || 0;
                    document.getElementById('classCapacity').value = cls.capacity || '';
                    document.getElementById('classFee').value = cls.fee || '';
                    document.getElementById('classStatus').value = cls.status || 'active';
                    document.getElementById('classOnline').checked = cls.online || false;

                    document.getElementById('classModalTitle').textContent = 'Edit Class';
                    document.getElementById('classModal').classList.remove('hidden');
                }

                async function deleteClass(classId) {
                    if (!confirm('Are you sure you want to delete this class?')) return;
                    if (!supabaseClient) return;

                    try {
                        const { error } = await supabaseClient
                            .from('classes')
                            .delete()
                            .eq('id', classId);

                        if (error) throw error;

                        await loadClasses();
                        updateAllStats();
                        showNotification('‚úÖ Class deleted!', 'success');
                    } catch (error) {
                        console.error('Error deleting class:', error);
                        showNotification('‚ùå Error deleting class', 'error');
                    }
                }

                function filterClasses(filter) {
                    const searchTerm = document.getElementById('classSearch').value.toLowerCase();
                    const instructorFilter = document.getElementById('classInstructorFilter').value;

                    if (filter) {
                        classFilter = filter;
                    }

                    filteredClasses = classesData.filter(cls => {
                        const matchesSearch = !searchTerm ||
                            (cls.name && cls.name.toLowerCase().includes(searchTerm)) ||
                            (cls.code && cls.code.toLowerCase().includes(searchTerm)) ||
                            (cls.instructor && cls.instructor.toLowerCase().includes(searchTerm));

                        const matchesInstructor = !instructorFilter || cls.instructor === instructorFilter;
                        const matchesStatus = classFilter === 'all' || cls.status === 'active' || !cls.status;

                        return matchesSearch && matchesInstructor && matchesStatus;
                    });

                    displayClasses();
                }

                function updateClassStats() {
                    const totalEnrolled = classesData.reduce((sum, cls) => sum + (cls.enrolled || 0), 0);
                    const uniqueInstructors = [...new Set(classesData.map(cls => cls.instructor).filter(Boolean))].length;
                    const avgEnrollment = classesData.length > 0 ? Math.round(totalEnrolled / classesData.length) : 0;

                    const elements = {
                        totalClassesCount: classesData.length,
                        totalEnrolled: totalEnrolled,
                        totalInstructors: uniqueInstructors,
                        avgEnrollment: avgEnrollment,
                        totalClasses: classesData.length
                    };

                    Object.entries(elements).forEach(([id, value]) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = value;
                    });
                }

                function updateInstructorFilter() {
                    const select = document.getElementById('classInstructorFilter');
                    if (!select) return;

                    const instructors = [...new Set(classesData.map(cls => cls.instructor).filter(Boolean))].sort();

                    const currentValue = select.value;
                    select.innerHTML = '<option value="">All Instructors</option>' +
                        instructors.map(instructor => `<option value="${instructor}">${instructor}</option>`).join('');

                    if (currentValue && instructors.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }

                // Modal Functions
                function openClassModal() {
                    document.getElementById('classEditId').value = '';
                    document.getElementById('classModalTitle').textContent = 'Add New Class';
                    document.getElementById('classModal').classList.remove('hidden');
                }

                function closeClassModal() {
                    document.getElementById('classModal').classList.add('hidden');
                    document.querySelector('#classModal form').reset();
                    document.getElementById('classEditId').value = '';
                }

                function closeClassDetailModal() {
                    document.getElementById('classDetailModal').classList.add('hidden');
                }  
            </script>

            <!-- SETTINGS PAGE -->
            <div id="settings-page" class="page-section">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-cog text-gray-600 mr-2"></i>Settings
                </h1>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Database Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-database text-blue-600 mr-2"></i>Database Connection
                        </h3>
                        <div class="space-y-4">
                            <div id="dbConnectionStatus" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="text-sm text-green-700 font-semibold">
                                    <i class="fas fa-check-circle mr-2"></i>Connected to Supabase
                                </p>
                                <p class="text-xs text-green-600 mt-1">All systems operational</p>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="testDatabaseConnection()"
                                    class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                                    <i class="fas fa-vial mr-2"></i>Test Connection
                                </button>
                                <button onclick="syncWithSupabase()"
                                    class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-medium">
                                    <i class="fas fa-sync mr-2"></i>Sync Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Email Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-envelope text-blue-600 mr-2"></i>Email Configuration
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">Service ID</label>
                                <input type="text" id="emailServiceId"
                                    class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="service_xxxxx"
                                    value="${EMAILJS_SERVICE_ID}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Template ID</label>
                                <input type="text" id="emailTemplateId"
                                    class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="template_xxxxx"
                                    value="${EMAILJS_TEMPLATE_ID}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Public Key</label>
                                <input type="text" id="emailPublicKey"
                                    class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="your_public_key"
                                    value="${EMAILJS_PUBLIC_KEY}">
                            </div>
                            <button onclick="saveEmailConfig()"
                                class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">
                                <i class="fas fa-save mr-2"></i>Save Configuration
                            </button>
                            <div id="emailStatusIndicator"
                                class="p-3 ${EMAILJS_SERVICE_ID ? 'bg-green-50 border-green-200 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-600'} border rounded-lg text-center text-xs font-medium">
                                <i
                                    class="fas ${EMAILJS_SERVICE_ID ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-1"></i>
                                ${EMAILJS_SERVICE_ID ? 'Email configured' : 'Email not configured'}
                            </div>
                        </div>
                    </div>

                    <!-- System Information -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>System Information
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Total Students</span>
                                <span class="font-semibold" id="settingsStudentCount">0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Total Visitors</span>
                                <span class="font-semibold" id="settingsVisitorCount">0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Total Tasks</span>
                                <span class="font-semibold" id="settingsTaskCount">0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Total Appointments</span>
                                <span class="font-semibold" id="settingsAppointmentCount">0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Total Classes</span>
                                <span class="font-semibold" id="settingsClassCount">0</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-600">Last Updated</span>
                                <span class="font-semibold text-xs" id="lastUpdated">Now</span>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-database text-purple-600 mr-2"></i>Data Management
                        </h3>
                        <div class="space-y-3">
                            <button onclick="exportAllData()"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                                <i class="fas fa-download mr-2"></i>Export All Data (JSON)
                            </button>
                            <button onclick="exportAllDataCSV()"
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">
                                <i class="fas fa-file-csv mr-2"></i>Export All Data (CSV)
                            </button>
                            <button onclick="syncWithSupabase()"
                                class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                                <i class="fas fa-sync mr-2"></i>Sync with Database
                            </button>
                            <button onclick="clearAllData()"
                                class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                                <i class="fas fa-trash mr-2"></i>Clear All Data
                            </button>
                        </div>
                        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <p class="text-xs text-amber-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                <strong>Warning:</strong> Clear All Data will permanently delete all records from the
                                database.
                            </p>
                        </div>
                    </div>

                    <!-- Google Sheets Integration -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-table text-green-600 mr-2"></i>Google Sheets Integration
                        </h3>
                        <div class="space-y-3">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-xs text-blue-800 font-medium mb-1">Students Sheet</p>
                                <p class="text-xs text-blue-600">Connected to Google Sheets</p>
                            </div>
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <p class="text-xs text-green-800 font-medium mb-1">Visitors Sheet</p>
                                <p class="text-xs text-green-600">Auto-sync enabled</p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="loadApplicantsFromSheet()"
                                    class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-xs font-medium">
                                    <i class="fas fa-sync mr-1"></i>Load Students
                                </button>
                                <button onclick="exportVisitorsToSheets()"
                                    class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-xs font-medium">
                                    <i class="fas fa-upload mr-1"></i>Export Visitors
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-user-cog text-indigo-600 mr-2"></i>Account Settings
                        </h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                                <p class="text-sm text-indigo-800 font-semibold mb-1">Logged in as</p>
                                <p class="text-sm text-indigo-600" id="settingsUserEmail">Loading...</p>
                            </div>

                            <div class="space-y-2">
                                <button onclick="changePassword()"
                                    class="w-full px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm font-medium">
                                    <i class="fas fa-key mr-2"></i>Change Password
                                </button>
                                <button onclick="logout()"
                                    class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- System Logs -->
                    <div class="bg-white rounded-xl shadow-sm p-6 lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-list-alt text-gray-600 mr-2"></i>Recent Activity
                        </h3>
                        <div id="activityLog" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="p-3 bg-gray-50 rounded-lg text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-700">System initialized</span>
                                    <span class="text-xs text-gray-500" id="initTime">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- App Version & Info -->
                    <div
                        class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg p-6 lg:col-span-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold mb-2">Demo Admin Dashboard</h3>
                                <p class="text-blue-100 text-sm mb-4">Complete management system for educational
                                    consultancy</p>
                                <div class="space-y-1 text-sm">
                                    <p><i class="fas fa-code-branch mr-2"></i>Version 2.0.0</p>
                                    <p><i class="fas fa-calendar mr-2"></i>Last Updated: January 2025</p>
                                    <p><i class="fas fa-server mr-2"></i>Powered by Rachit Pokhrel</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div
                                    class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mb-2">
                                    <i class="fas fa-graduation-cap text-3xl"></i>
                                </div>
                                <p class="text-xs text-blue-100">Demo Consultancy Name</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        async function syncWithSupabase() {
            showNotification('üîÑ Syncing with database...', 'info');
            try {
                await loadAllDataFromSupabase();
                updateAllStats();
                addActivityLog('Data synced with Supabase');
                showNotification('‚úÖ Sync complete!', 'success');
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Sync failed: ' + error.message, 'error');
            }
        }
        // ==================== SETTINGS FUNCTIONS ====================
        async function testDatabaseConnection() {
            showNotification('üîç Testing database connection...', 'info');

            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('count')
                    .limit(1);

                if (error) throw error;

                const statusEl = document.getElementById('dbConnectionStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                <p class="text-sm text-green-700 font-semibold">
                    <i class="fas fa-check-circle mr-2"></i>Connection Successful
                </p>
                <p class="text-xs text-green-600 mt-1">Database responding normally</p>
            `;
                }

                addActivityLog('Database connection test successful');
                showNotification('‚úÖ Database connection successful!', 'success');
            } catch (error) {
                console.error('Database connection error:', error);

                const statusEl = document.getElementById('dbConnectionStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                <p class="text-sm text-red-700 font-semibold">
                    <i class="fas fa-exclamation-circle mr-2"></i>Connection Failed
                </p>
                <p class="text-xs text-red-600 mt-1">${error.message}</p>
            `;
                    statusEl.className = 'p-4 bg-red-50 border border-red-200 rounded-lg';
                }

                showNotification('‚ùå Database connection failed', 'error');
            }
        }

        function saveEmailConfig() {
            const serviceId = document.getElementById('emailServiceId').value;
            const templateId = document.getElementById('emailTemplateId').value;
            const publicKey = document.getElementById('emailPublicKey').value;

            if (!serviceId || !templateId || !publicKey) {
                showNotification('‚ö†Ô∏è Please fill in all email configuration fields', 'warning');
                return;
            }

            // Store in localStorage (in production, this should be more secure)
            localStorage.setItem('emailjs_service_id', serviceId);
            localStorage.setItem('emailjs_template_id', templateId);
            localStorage.setItem('emailjs_public_key', publicKey);

            // Update EmailJS
            emailjs.init(publicKey);

            const statusEl = document.getElementById('emailStatusIndicator');
            if (statusEl) {
                statusEl.className = 'p-3 bg-green-50 border border-green-200 text-green-700 text-center text-xs font-medium';
                statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Email configured successfully';
            }

            addActivityLog('Email configuration updated');
            showNotification('‚úÖ Email configuration saved!', 'success');
        }

        async function exportAllData() {
            showNotification('üì¶ Preparing export...', 'info');

            const allData = {
                exportInfo: {
                    timestamp: new Date().toISOString(),
                    version: '2.0.0',
                    exportedBy: window.currentUser?.email || 'Unknown'
                },
                students: applicantsData,
                visitors: visitorsData,
                tasks: tasksData,
                appointments: appointmentsData,
                classes: classesData,
                statistics: {
                    totalStudents: applicantsData.length,
                    totalVisitors: visitorsData.length,
                    totalTasks: tasksData.length,
                    totalAppointments: appointmentsData.length,
                    totalClasses: classesData.length
                }
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `discovery-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            addActivityLog('Full data export completed');
            showNotification('‚úÖ Data exported successfully!', 'success');
        }

        async function exportAllDataCSV() {
            showNotification('üìä Preparing CSV exports...', 'info');

            try {
                // Export Students
                if (applicantsData.length > 0) {
                    const headers = Object.keys(applicantsData[0]);
                    const csvContent = [
                        headers.join(','),
                        ...applicantsData.map(row =>
                            headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                        )
                    ].join('\n');

                    downloadCSV(csvContent, 'students');
                }

                // Export Visitors
                if (visitorsData.length > 0) {
                    downloadVisitorsCSV();
                }

                // Export Tasks
                if (tasksData.length > 0) {
                    const taskHeaders = ['ID', 'Title', 'Assignee', 'Email', 'Priority', 'Status', 'Due Date', 'Created'];
                    const taskCSV = [
                        taskHeaders.join(','),
                        ...tasksData.map(t => [
                            t.id,
                            `"${t.title}"`,
                            `"${t.assignee_name}"`,
                            t.assignee_email,
                            t.priority,
                            t.status,
                            t.due_date || '',
                            new Date(t.created_at).toLocaleDateString()
                        ].join(','))
                    ].join('\n');

                    downloadCSV(taskCSV, 'tasks');
                }

                addActivityLog('CSV export completed');
                showNotification('‚úÖ All data exported as CSV!', 'success');
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('‚ùå CSV export failed', 'error');
            }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL data from the database!\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?')) {
                return;
            }

            const confirmation = prompt('Type "DELETE ALL DATA" to confirm:');
            if (confirmation !== 'DELETE ALL DATA') {
                showNotification('‚ùå Deletion cancelled', 'info');
                return;
            }

            showNotification('üóëÔ∏è Deleting all data...', 'info');

            try {
                // Delete all records from each table
                const tables = ['tasks', 'appointments', 'classes', 'visitors'];

                for (const table of tables) {
                    const { error } = await supabaseClient
                        .from(table)
                        .delete()
                        .neq('id', 0);

                    if (error) {
                        console.error(`Error deleting from ${table}:`, error);
                    }
                }

                // Clear local data
                tasksData = [];
                appointmentsData = [];
                classesData = [];
                visitorsData = [];
                applicantsData = [];

                // Reload all data
                await loadAllDataFromSupabase();

                addActivityLog('All data cleared from database');
                showNotification('‚úÖ All data has been deleted!', 'success');
            } catch (error) {
                console.error('Error clearing data:', error);
                showNotification('‚ùå Error clearing data: ' + error.message, 'error');
            }
        }

        function changePassword() {
            showNotification('‚ÑπÔ∏è Password change feature coming soon', 'info');
            // This would typically redirect to a password change page or open a modal
        }

        function addActivityLog(message) {
            const logContainer = document.getElementById('activityLog');
            if (!logContainer) return;

            const logEntry = document.createElement('div');
            logEntry.className = 'p-3 bg-gray-50 rounded-lg text-sm';
            logEntry.innerHTML = `
        <div class="flex justify-between items-center">
            <span class="text-gray-700">${message}</span>
            <span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span>
        </div>
    `;

            // Insert at the beginning
            if (logContainer.firstChild) {
                logContainer.insertBefore(logEntry, logContainer.firstChild);
            } else {
                logContainer.appendChild(logEntry);
            }

            // Keep only last 10 entries
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // ==================== COMPLETE UPDATE ALL STATS FUNCTION ====================
        function updateAllStats() {
            // Students
            const totalApplicants = document.getElementById('totalApplicants');
            if (totalApplicants) totalApplicants.textContent = applicantsData.length;

            const settingsStudentCount = document.getElementById('settingsStudentCount');
            if (settingsStudentCount) settingsStudentCount.textContent = applicantsData.length;

            // Visitors
            const totalVisitors = document.getElementById('totalVisitors');
            if (totalVisitors) totalVisitors.textContent = visitorsData.length;

            const settingsVisitorCount = document.getElementById('settingsVisitorCount');
            if (settingsVisitorCount) settingsVisitorCount.textContent = visitorsData.length;

            updateVisitorStats();

            // Tasks
            const todoCount = tasksData.filter(t => t.status === 'todo').length;
            const inProgressCount = tasksData.filter(t => t.status === 'inprogress').length;
            const doneCount = tasksData.filter(t => t.status === 'done').length;

            const pendingTasks = document.getElementById('pendingTasks');
            const todoCountEl = document.getElementById('todoCount');
            const inProgressCountEl = document.getElementById('inProgressCount');
            const doneCountEl = document.getElementById('doneCount');
            const settingsTaskCount = document.getElementById('settingsTaskCount');

            if (pendingTasks) pendingTasks.textContent = todoCount + inProgressCount;
            if (todoCountEl) todoCountEl.textContent = todoCount;
            if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;
            if (doneCountEl) doneCountEl.textContent = doneCount;
            if (settingsTaskCount) settingsTaskCount.textContent = tasksData.length;

            // Appointments
            updateAppointmentStats();
            const settingsAppointmentCount = document.getElementById('settingsAppointmentCount');
            if (settingsAppointmentCount) settingsAppointmentCount.textContent = appointmentsData.length;

            // Classes
            const totalClasses = document.getElementById('totalClasses');
            if (totalClasses) totalClasses.textContent = classesData.length;

            const settingsClassCount = document.getElementById('settingsClassCount');
            if (settingsClassCount) settingsClassCount.textContent = classesData.length;

            updateClassStats();

            // Last Updated
            const lastUpdated = document.getElementById('lastUpdated');
            if (lastUpdated) {
                const now = new Date();
                lastUpdated.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            // Settings user email
            const settingsUserEmail = document.getElementById('settingsUserEmail');
            if (settingsUserEmail && window.currentUser) {
                settingsUserEmail.textContent = window.currentUser.email;
            }

            // Update charts
            updateVisitorCharts();
            displayUpcomingAppointments();
        }

        // ==================== REFRESH ALL DATA ====================
        async function refreshAllData() {
            showNotification('üîÑ Refreshing all data...', 'info');

            try {
                await loadAllDataFromSupabase();

                // If students page needs Google Sheets data
                if (applicantsData.length === 0) {
                    await loadApplicantsFromSheet();
                }

                updateAllStats();
                addActivityLog('All data refreshed');
                showNotification('‚úÖ Data refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('‚ùå Error refreshing data', 'error');
            }
        }
        // Auto-refresh visitors every 30 seconds
        let visitorRefreshInterval;

        function startAutoRefresh() {
            // Clear any existing interval
            if (visitorRefreshInterval) {
                clearInterval(visitorRefreshInterval);
            }

            // Refresh every 30 seconds
            visitorRefreshInterval = setInterval(async () => {
                console.log('üîÑ Auto-refreshing visitors...');
                await loadVisitors();
            }, 30000); // 30 seconds
        }

        // Start auto-refresh when dashboard loads
        window.addEventListener('load', () => {
            startAutoRefresh();
            console.log('‚úÖ Auto-refresh enabled (every 30 seconds)');
        });

        // Stop auto-refresh when page unloads
        window.addEventListener('beforeunload', () => {
            if (visitorRefreshInterval) {
                clearInterval(visitorRefreshInterval);
            }
        });

        // For INSTANT updates (better than polling), add this:

        function setupRealtimeSubscription() {
            if (!supabaseClient) return;

            console.log('üîî Setting up real-time subscriptions...');

            // Subscribe to visitor changes
            const visitorChannel = supabaseClient
                .channel('visitors_changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'visitors'
                    },
                    (payload) => {
                        console.log('üîî Visitor change detected:', payload);

                        // Reload visitors data
                        loadVisitors();

                        // Show notification
                        if (payload.eventType === 'INSERT') {
                            showNotification('üÜï New visitor registered!', 'success');
                        } else if (payload.eventType === 'UPDATE') {
                            showNotification('üìù Visitor updated', 'info');
                        } else if (payload.eventType === 'DELETE') {
                            showNotification('üóëÔ∏è Visitor deleted', 'info');
                        }
                    }
                )
                .subscribe();

            console.log('‚úÖ Real-time subscriptions active');
        }

        // Call this in your window.load event:
        window.addEventListener('load', async () => {

            // Enable real-time updates
            setupRealtimeSubscription();
        });

        // ==================== LOAD ALL DATA FROM SUPABASE ====================
        async function loadAllDataFromSupabase() {
            if (!supabaseClient) {
                console.warn('‚ö†Ô∏è Supabase client not initialized');
                return;
            }

            console.log('üîÑ Loading all data from Supabase...');

            try {
                await Promise.all([
                    loadTasks(),
                    loadAppointments(),
                    loadClasses(),
                    loadVisitors()  // ‚úÖ MAKE SURE THIS IS HERE
                ]);

                updateAllStats();
                console.log('‚úÖ All data loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showNotification('‚ö†Ô∏è Some data failed to load', 'warning');
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', async () => {
            console.log('üöÄ Initializing Admin Dashboard...');

            // Initialize Supabase
            initSupabase(SUPABASE_URL, SUPABASE_KEY);

            // Initialize EmailJS
            if (EMAILJS_PUBLIC_KEY) {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }

            // Display user info
            await displayUserInfo();

            // IMPORTANT: Load all data from Supabase
            await loadAllDataFromSupabase();

            // Set initial time
            const initTimeEl = document.getElementById('initTime');
            if (initTimeEl) {
                initTimeEl.textContent = new Date().toLocaleTimeString();
            }

            // Add initial activity log
            setTimeout(() => {
                addActivityLog('Dashboard loaded successfully');
                showNotification('‚úÖ System Ready', 'success');
            }, 1000);
        });

        // ==================== UTILITY FUNCTIONS ====================
        function showPage(event, pageName) {
            event.preventDefault();

            // Hide all pages
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected page
            const selectedPage = document.getElementById(pageName + '-page');
            if (selectedPage) {
                selectedPage.classList.add('active');
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Close mobile sidebar
            closeSidebar();

            // Log page view
            addActivityLog(`Viewed ${pageName} page`);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('sidebar-mobile');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.add('sidebar-mobile');
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-amber-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[100] text-sm font-medium`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 300ms';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
    <script>

        // ==================== CRITICAL: AUTHENTICATION PROTECTION ====================
        // THIS MUST BE AT THE TOP - DO NOT REMOVE OR MOVE

        const DASHBOARD_SUPABASE_URL = 'https://rdzdermrmvbhfbynxqxy.supabase.co';
        const DASHBOARD_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkemRlcm1ybXZiaGZieW54cXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzEzOTgsImV4cCI6MjA4MjY0NzM5OH0.9MK2u6YUHmNGI85U_-suG_SogbRy9lLsqpB6SFdIrtA';

        // Initialize Supabase for auth check IMMEDIATELY
        const { createClient: createAuthClient } = supabase;
        const authClient = createAuthClient(DASHBOARD_SUPABASE_URL, DASHBOARD_SUPABASE_KEY);

        // IMMEDIATE AUTH CHECK - Blocks unauthorized access
        // IMMEDIATE AUTH CHECK - Blocks unauthorized access
        (async function () {
            try {
                const { data: { session }, error } = await authClient.auth.getSession();

                if (error || !session) {
                    console.warn('‚ö†Ô∏è Unauthorized access attempt blocked');
                    window.location.replace('admin-login.html');
                    throw new Error('Authentication required');
                }

                if (session && session.user) {
                    console.log('‚úÖ Authenticated user:', session.user.email);
                    // Store user info globally
                    window.currentUser = session.user;
                    window.currentSession = session;

                    // Display user info immediately after auth check
                    setTimeout(() => {
                        displayUserInfo();
                    }, 100);
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.replace('admin-login.html');
            }
        })();

        // Monitor auth state changes (logout, token expiry)
        authClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                console.warn('‚ö†Ô∏è Session expired or signed out');
                window.location.replace('admin-login.html');
            }
        });

        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
                const { error } = await authClient.auth.signOut();
                if (error) throw error;

                // Clear all stored data
                localStorage.clear();
                sessionStorage.clear();

                // Redirect to login
                window.location.replace('admin-login.html');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Redirecting anyway...');
                window.location.replace('admin-login.html');
            }
        }

        // Display logged-in user info
        // Display logged-in user info
        // Display logged-in user info
        // Display logged-in user info (COMPLETE VERSION)
        async function displayUserInfo() {
            try {
                const { data: { session } } = await authClient.auth.getSession();

                if (session && session.user) {
                    const userEmail = session.user.email;
                    const displayName = getDisplayName(userEmail);
                    const greeting = getTimeBasedGreeting();

                    // Update main display name (top right)
                    const userEmailEl = document.getElementById('userEmail');
                    if (userEmailEl) {
                        userEmailEl.textContent = displayName;
                    }

                    // Update dropdown email
                    const userEmailDropdown = document.getElementById('userEmailDropdown');
                    if (userEmailDropdown) {
                        userEmailDropdown.textContent = userEmail;
                    }

                    // Update welcome message with time-based greeting
                    const welcomeMessage = document.getElementById('welcomeMessage');
                    if (welcomeMessage) {
                        welcomeMessage.textContent = `${greeting}, ${displayName}`;
                    }

                    // Update greeting text
                    const greetingText = document.getElementById('greetingText');
                    if (greetingText) {
                        greetingText.textContent = 'Welcome back,';
                    }

                    console.log(`‚úÖ ${greeting}, ${displayName}!`);
                } else {
                    window.location.replace('admin-login.html');
                }
            } catch (error) {
                console.error('Error displaying user info:', error);
                const userEmailEl = document.getElementById('userEmail');
                if (userEmailEl) {
                    userEmailEl.textContent = 'Admin User';
                }
            }
        }
        // ==================== USER DISPLAY NAMES MAPPING ====================
        const USER_DISPLAY_NAMES = {
            'rachitpokhrel123@gmail.com': 'Rachit Pokhrel',
            'banepa@discoveryedu.com.np': 'Discovery Staff',
            'amit@discoveryedu.com.np': 'Amit Neupane',
            'suman@discoveryedu.com.np': 'Suman Gautam',
            'arpan.discoveryedu@gmail.com': 'Arpan Poudel',
            'chaulagainyounesh@gmail.com': 'Nirmal Chaulagain',
            'demo@gmail.com': 'Demo Login',
        };

        // Function to get display name from email
        function getDisplayName(email) {
            return USER_DISPLAY_NAMES[email.toLowerCase()] || email.split('@')[0];
        }
        // ==================== END AUTHENTICATION PROTECTION ====================
        // Get greeting based on time of day
        function getTimeBasedGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good Morning';
            if (hour < 17) return 'Good Afternoon';
            return 'Good Evening';
        }
        // Configuration
        const SHEET_ID = '1WGcsbCmocmwItPC0XdaLkfb9UoN-OVYgTu1m0HglLm0';
        const API_KEY = 'AIzaSyB7fuRTNZqyb6juWEJeIzfyCb2Zh8yO6s4';
        const SHEET_NAME = 'Admission';
        const SUPABASE_URL = 'https://rdzdermrmvbhfbynxqxy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkemRlcm1ybXZiaGZieW54cXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzEzOTgsImV4cCI6MjA4MjY0NzM5OH0.9MK2u6YUHmNGI85U_-suG_SogbRy9lLsqpB6SFdIrtA';
        // EmailJS Pre-Configuration - Add your credentials here
        const EMAILJS_SERVICE_ID = 'service_neeqisg';  // Replace with your actual Service ID
        const EMAILJS_TEMPLATE_ID = 'template_7ci3arc'; // Replace with your actual Template ID
        const EMAILJS_PUBLIC_KEY = 'xE-BfiszwSK3J4Xsb'; // Replace with your actual Public Key

        // Global Variables
        let supabaseClient;
        let applicantsData = [];
        let tasksData = [];
        let appointmentsData = [];
        let classesData = [];

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', async () => {
            initSupabase(SUPABASE_URL, SUPABASE_KEY);
            emailjs.init(EMAILJS_PUBLIC_KEY);

            // Display user info with a slight delay to ensure DOM is ready
            await displayUserInfo();

            setTimeout(() => showNotification('‚úÖ System Ready', 'success'), 1000);
        });

        function initSupabase(url, key) {
            const { createClient } = supabase;
            supabaseClient = createClient(url, key);
            loadAllDataFromSupabase();
        }

        async function loadAllDataFromSupabase() {
            if (!supabaseClient) return;
            await Promise.all([loadTasks(), loadAppointments(), loadClasses()]);
            updateAllStats();
        }

        // ==================== AUTHENTICATION CHECK ====================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                // Not logged in, redirect to login
                window.location.href = 'login.html';
                return false;
            }

            // Optional: Display logged-in user info
            const userEmail = session.user.email;
            console.log('Logged in as:', userEmail);

            return true;
        }

        // Check authentication immediately when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });
    </script>
</body>

</html>